<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–ì—Ä–∞—Ñ—ñ–∫ –°–≤—ñ—Ç–ª–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #12121a;
            --card-bg: #1e1e2a;
            --text-main: #ffffff;
            --text-muted: #8e8e93;
            --accent-green: #2ecc71;
            --accent-red: #e74c3c;
            --accent-gray: #3a3a45;
            --line-color: #2c2c35;
            --glass-bg: rgba(255,255,255,0.08);
            --shadow-color: rgba(0,0,0,0.45);
            --radius: 16px;
        }

        [data-theme="light"] {
            --bg-color: #f2f2f7;
            --card-bg: #ffffff;
            --text-main: #000000;
            --text-muted: #6e6e73;
            --line-color: #d1d1d6;
            --glass-bg: rgba(0,0,0,0.05);
            --shadow-color: rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            transition: background-color 0.3s, color 0.3s;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(128, 128, 128, 0.3); border-radius: 10px; }

        /* --- HEADER --- */
        .header {
            width: 100%; padding: 20px 20px 10px 20px;
            display: flex; justify-content: center; align-items: center;
            position: sticky; top: 0; z-index: 50;
            background: var(--bg-color); transition: background 0.3s;
        }

        .queue-select-btn {
            display: inline-flex; align-items: center; gap: 8px;
            font-size: 18px; font-weight: 700; color: var(--text-main);
            background: var(--glass-bg);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            padding: 8px 16px; border-radius: 20px;
            cursor: pointer; transition: 0.2s; border: 1px solid rgba(128,128,128,0.1);
        }
        .queue-select-btn:active { opacity: 0.7; }
        .arrow-icon { font-size: 12px; opacity: 0.7; transition: 0.3s; }
        .queue-select-btn.open .arrow-icon { transform: rotate(180deg); }

        .top-bar {
            width: 100%; display: flex; justify-content: space-between;
            align-items: center; padding: 10px 16px 0 16px; margin-top: 4px; gap: 10px;
        }
        .top-bar .users {
            display: flex;
            align-items: center;
            gap: 4px;
            color: var(--text-muted);
            white-space: nowrap;
        }
        .top-bar .updated { color: var(--text-muted); font-size: 11px; font-weight: 500; }
        .top-bar .users #topUsers { position: relative; top: 1px; }

        #app-content {
            width: 100%;
            max-width: 500px;
            padding: 0 24px;
            padding-bottom: 120px; /* —â–æ–± –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ —Ö–æ–≤–∞–≤—Å—è –ø—ñ–¥ —Ç–∞–±–∞–º–∏ */
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .emergency-overlay {
            opacity: 0;
            visibility: hidden;
            transition: 0.3s;
        }
        .emergency-overlay.show {
            opacity: 1;
            visibility: visible;
        }


                .emergency-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.65);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0; visibility: hidden;
            transition: 0.3s;
        }

        .emergency-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .emergency-box {
            background: var(--card-bg);
            border-radius: 20px;
            width: 88%;
            max-width: 360px;
            padding: 26px 22px 22px;
            text-align: center;
            border: 1px solid rgba(255,0,0,0.25);
            box-shadow: 0 10px 28px rgba(255,0,0,0.25);
        }

        .emergency-title {
            font-size: 20px;
            font-weight: 800;
            color: #ff4d4d;
            margin-bottom: 12px;
        }

        .emergency-text {
            color: var(--text-main);
            opacity: 0.9;
            font-size: 15px;
            margin-bottom: 22px;
            line-height: 1.45;
        }

        .emergency-btn {
            width: 100%;
            padding: 12px;
            background: #ff4d4d;
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: 700;
        }


        /* --- –ë–ê–¢–ê–†–ï–ô–ö–ê --- */
        .battery-container { display: flex; flex-direction: column; align-items: center; margin-top: 10px; }
        .battery-wrapper { display: flex; align-items: center; position: relative; }
        .battery-shell {
            width: 160px; height: 48px;
            border: 3px solid rgba(128,128,128,0.3); border-radius: 14px;
            padding: 4px; position: relative;
        }
        .battery-tip { width: 6px; height: 18px; background: rgba(128,128,128,0.3); border-radius: 0 4px 4px 0; margin-left: 4px; }

        .battery-fill {
            height: 100%; width: 100%; border-radius: 9px;
            position: relative; overflow: hidden;
            transition: width 0.5s linear, background 0.5s linear, box-shadow 0.5s linear;
        }

        /* —Å—ñ—Ä–∞ –±–∞—Ç–∞—Ä–µ–π–∫–∞ –∫–æ–ª–∏ –≥—Ä–∞—Ñ—ñ–∫ –Ω–µ–≤—ñ–¥–æ–º–∏–π */
        .battery-fill.fill-gray {
            background: #555;
            box-shadow: none;
        }

        .share-wrapper {
            width: 100%;
            display: flex;
            justify-content: center;
        }

        .share-btn {
            background: none;               /* –º—ñ–Ω—ñ–º–∞–ª—ñ–∑–º */
            color: #46c97f;                 /* –∞–∫—É—Ä–∞—Ç–Ω–∏–π –∑–µ–ª–µ–Ω–∏–π */
            font-size: 15px;
            font-weight: 600;
            padding: 10px 4px;
            cursor: pointer;
            border: none;
            border-radius: 12px;
            transition: 0.25s ease;
        }

        .share-btn:active {
            opacity: 0.6;
            transform: scale(0.97);
        }

        /* –ø–ª–∞–≤–Ω–∞ –ø–æ—è–≤–∞ */
        .share-wrapper.fade-in {
            animation: fadeInShare 0.4s ease forwards;
        }

        @keyframes fadeInShare {
            from { opacity: 0; transform: translateY(6px); }
            to   { opacity: 1; transform: translateY(0); }
        }


        .emergency-banner {
            text-align: center;
            color: #ff4d4d;
            font-size: 14px;
            font-weight: 700;
            margin-top: -4px;
            margin-bottom: 8px;
            animation: pulseEmergency 1.2s infinite ease-in-out;
        }

        @keyframes pulseEmergency {
            0%   { opacity: 0.7; }
            50%  { opacity: 1;   }
            100% { opacity: 0.7; }
        }

        .share-btn:active {
            transform: scale(0.96);
        }

        .battery-fill::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-image: linear-gradient(45deg, rgba(255,255,255,0.1) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.1) 75%, transparent 75%, transparent);
            background-size: 20px 20px; z-index: 2;
            animation: moveRight 4s linear infinite;
        }
        .battery-fill.discharging::after { animation-name: moveLeft; }

        @keyframes moveRight { 0% { background-position: 0 0; } 100% { background-position: 40px 0; } }
        @keyframes moveLeft  { 0% { background-position: 0 0; } 100% { background-position: -40px 0; } }

        .battery-text {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 22px; font-weight: 700; text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            font-variant-numeric: tabular-nums; width: 100%; text-align: center; z-index: 5; color: white;
        }
        .battery-status { margin-top: 8px; font-size: 13px; color: var(--text-muted); font-weight: 500; }

        /* --- –î–ê–¢–ê --- */
        .date-header { display: flex; align-items: center; gap: 10px; margin: 12px 0 4px; justify-content: center; }
        .date-line { flex: 1; height: 1px; background: var(--line-color); }
        .date-text { font-size: 14px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }

        /* --- –ì–û–õ–û–í–ù–ò–ô –ë–õ–û–ö –î–ù–Ø (—Å–ª–∞–π–¥–∏—Ç—å—Å—è) --- */
        .day-body {
            position: relative;
            transition: transform .25s ease, opacity .25s ease;
            will-change: transform, opacity;
        }

        .timeline-section { width: 100%; margin-top: 4px; }
        .timeline-box { position: relative; padding: 0 12px; }

        .timeline-track {
            position: relative; width: 100%; height: 44px;
            display: flex; align-items: stretch; gap: 0;
            background: transparent; padding: 0; box-shadow: none; overflow: visible;
        }

        .segment {
            position: relative; flex-grow: 1; flex-basis: 0; height: 100%; min-width: 32px;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 6px 14px var(--shadow-color); overflow: hidden;
            cursor: pointer; transition: transform 0.15s ease, box-shadow 0.15s ease;
            z-index: 20;
            border-left: 1px solid var(--bg-color); border-right: 1px solid var(--bg-color);
            background-clip: padding-box;
        }
        .segment:first-child { border-left: none; }
        .segment:last-child  { border-right: none; }
        .segment-selected { transform: translateY(-2px); outline: 2px solid var(--text-main); box-shadow: 0 0 16px rgba(255,255,255,0.4); }

        .on { background-color: var(--accent-green); }
        .off { background-color: var(--accent-red); }
        .segment-icon { font-size: 18px; color: white; z-index: 2; filter: drop-shadow(0 1px 1px rgba(0,0,0,0.25)); opacity: 0.95; }

        .cursor-line {
            position: absolute; top: 0; bottom: 0; width: 2px; background: #ffffff;
            z-index: 30; border-radius: 4px; box-shadow: 0 0 8px rgba(255,255,255,0.8);
            pointer-events: none; transform: translateX(-50%);
        }

        .time-labels { position: relative; width: 100%; height: 24px; margin-top: 8px; padding: 0; left: -1px; }
        .t-label {
            position: absolute; top: 0; font-size: 11px; font-weight: 600; color: var(--text-muted);
            transform: translateX(-50%); white-space: nowrap; letter-spacing: 0.3px;
        }
        .t-tick {
            position: absolute; top: -6px; left: 50%; width: 1px; height: 4px; background: var(--text-muted);
            transform: translateX(-50%);
        }

        @keyframes pulseActive {
            0% { transform: scale(1); }
            40% { transform: scale(1.06); }
            100% { transform: scale(1); }
        }

        .q-item.pulse {
            animation: pulseActive 1.2s ease;
        }


        /* --- CARD LIST --- */
        .card-list { display: flex; flex-direction: column; gap: 12px; margin-top: 12px; }
        .card {
            background: var(--card-bg); border-radius: var(--radius); padding: 16px;
            display: flex; flex-direction: column; position: relative; overflow: hidden;
            border: 2px solid transparent; transition: all 0.3s ease;
            box-shadow: 0 4px 12px var(--shadow-color);
        }
        .card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; }
        .card.c-on::before  { background: var(--accent-green); }
        .card.c-off::before { background: var(--accent-red); }
        .card-header { display: flex; justify-content: space-between; align-items: center; gap: 12px; }

        @keyframes pulseGreen { 0% { box-shadow: 0 0 15px rgba(46, 204, 113, 0.3); transform: scale(1); } 50% { box-shadow: 0 0 30px rgba(46, 204, 113, 0.6); transform: scale(1.02); } 100% { box-shadow: 0 0 15px rgba(46, 204, 113, 0.3); transform: scale(1); } }
        @keyframes pulseRed   { 0% { box-shadow: 0 0 15px rgba(231, 76, 60, 0.3); transform: scale(1); } 50% { box-shadow: 0 0 30px rgba(231, 76, 60, 0.6); transform: scale(1.02); } 100% { box-shadow: 0 0 15px rgba(231, 76, 60, 0.3); transform: scale(1); } }

        .card.active-now { z-index: 10; border-width: 2px; }
        .card.active-now.c-on  { border-color: var(--accent-green); animation: pulseGreen 2s infinite ease-in-out; }
        .card.active-now.c-off { border-color: var(--accent-red);  animation: pulseRed  2s infinite ease-in-out; }
        .card.active-now::before { display: none; }

        .card-info { display: flex; align-items: center; gap: 14px; }
        .c-icon { font-size: 20px; width: 24px; text-align: center; }
        .c-times { display: flex; flex-direction: column; gap: 2px; }
        .status-label { font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
        .c-on  .status-label { color: var(--accent-green); }
        .c-off .status-label { color: var(--accent-red); }
        .c-time { font-size: 16px; font-weight: 700; color: var(--text-main); }
        .c-dur  { font-size: 14px; font-weight: 500; color: var(--text-muted); }

        .card-details {
            padding: 0 2px 0 2px; font-size: 13px; color: var(--text-muted); line-height: 1.5;
            max-height: 0; opacity: 0; overflow: hidden; transition: all 0.25s ease;
        }
        .card.expanded .card-details { max-height: 200px; opacity: 1; margin-top: 10px; border-top: 1px solid rgba(128,128,128,0.1); padding-top: 10px; }

        /* --- DETAIL CARD --- */
        @keyframes popInSpring  { 0% { opacity: 0; transform: translateY(-20px) scale(0.95); } 100% { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes popOutSpring { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-20px) scale(0.95); } }
        .detail-card-container { margin-top: 12px; }
        .detail-card {
            background: var(--card-bg); border-radius: var(--radius);
            padding: 16px 18px 14px; border: 2px solid transparent;
            box-shadow: 0 10px 25px var(--shadow-color); position: relative; overflow: hidden;
            animation: popInSpring 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .detail-card.closing { animation: popOutSpring 0.3s ease-in forwards; }
        .detail-card.on  { border-color: var(--accent-green); box-shadow: 0 0 18px rgba(46, 204, 113, 0.35); }
        .detail-card.off { border-color: var(--accent-red);  box-shadow: 0 0 18px rgba(231, 76, 60, 0.35); }
        .detail-header, .detail-left { display: flex; align-items: center; gap: 12px; justify-content: space-between; }
        .detail-main { display: flex; flex-direction: column; gap: 3px; }
        .detail-status { font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
        .detail-status-on  { color: var(--accent-green); }
        .detail-status-off { color: var(--accent-red); }
        .detail-time { font-size: 16px; font-weight: 700; color: var(--text-main); }
        .detail-duration { font-size: 14px; font-weight: 600; color: var(--text-muted); white-space: nowrap; }
        .detail-divider { margin: 10px 0 8px 0; height: 1px; background: rgba(128,128,128,0.1); }
        .detail-body { font-size: 14px; line-height: 1.45; color: var(--text-main); opacity: 0.8; }
        .detail-body p { margin: 0 0 4px 0; }
        .detail-note { margin-top: 6px; font-size: 12px; font-style: italic; color: var(--text-muted); }

        /* --- FOOTER (–ø—ñ–¥—Å—É–º–æ–∫ + –¥–æ–Ω–∞—Ç) --- */
        .total-block {
            display: inline-block; background: var(--glass-bg);
            padding: 8px 16px; border-radius: 20px; border: 1px solid rgba(128,128,128,0.1);
            margin-bottom: 15px; margin-left: auto; margin-right: auto; width: fit-content; margin-top: 20px !important;
            color: var(--text-muted); font-size: 14px; font-weight: 500;
        }
        .total-block b { color: var(--text-main); }

        .donate-wrapper {
            display: flex;
            justify-content: center;
            width: 100%;
            margin-top: 8px;
            margin-bottom: 16px;
        }

        .donate-btn {
            position: relative;
            width: 100%;
            height: 56px;
            background: #1a1a1a;
            border: none;
            border-radius: 16px;
            overflow: hidden;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            margin-left: 0;
        }

        .donate-btn:active { transform: scale(0.98); }

        .donate-progress {
            position: absolute; top: 0; left: 0; bottom: 0;
            width: 0%;
            background: linear-gradient(90deg, #FFC107, #FF9800);
            opacity: 0.8;
            transition: width 1.5s cubic-bezier(0.22, 1, 0.36, 1);
            z-index: 1;
        }

        .tomorrow-hint {
            text-align: center;
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 10px;
        }
        .hidden { display: none; }

        /* --- SWIPE ANIMATION --- */
        #app-content {
            transition: transform 0.25s ease;
        }

        .swipe-left {
            transform: translateX(-100%);
        }
        .swipe-right {
            transform: translateX(100%);
        }
        .swipe-reset {
            transform: translateX(0);
        }

        .donate-content {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            line-height: 1.3;
        }

        .donate-title {
            font-size: 15px;
            font-weight: 800;
            color: white;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .donate-amount {
            font-size: 13px;
            font-weight: 600;
            color: rgba(255,255,255,0.7);
        }

        /* --- TABS --- */
        .tab-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(24, 24, 32, 0.95); backdrop-filter: blur(10px);
            border-top: 1px solid rgba(128,128,128,0.1);
            display: flex; padding: 10px 20px 30px 20px;
            justify-content: space-between; gap: 10px; z-index: 80;
        }
        [data-theme="light"] .tab-bar { background: rgba(255, 255, 255, 0.95); }

        .tab-item {
            flex: 1; background: transparent; border: none; padding: 10px;
            border-radius: 12px; color: var(--text-muted);
            font-size: 14px; font-weight: 600; cursor: pointer; transition: 0.2s; text-align: center;
        }

        .tab-item.active { background: var(--glass-bg); color: var(--text-main); }

        /* --- POPUP MENU (FAB) --- */
        .fab-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
            z-index: 89; opacity: 0; visibility: hidden; transition: all 0.3s ease;
        }
        .fab-overlay.active { opacity: 1; visibility: visible; }

        .fab-container {
            position: fixed;
            bottom: 90px;     /* –±—É–ª–æ 70 ‚Äî –∑–∞–º—ñ–Ω–∏—Ç–∏ */
            right: 20px;
            z-index: 90;

            pointer-events: none; /* —è–∫ –±—É–ª–æ */

            display: flex;           /* –î–û–î–ê–¢–ò */
            flex-direction: column;  /* –î–û–î–ê–¢–ò */
            align-items: flex-end;   /* –î–û–î–ê–¢–ò */
        }


        .fab-main {
            width: 54px; height: 54px; border-radius: 50%;
            background: var(--accent-green); color: white;
            display: flex; align-items: center; justify-content: center;
            font-size: 26px; cursor: pointer;
            box-shadow: 0 4px 20px rgba(46, 204, 113, 0.5);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), background 0.3s;
            flex-shrink: 0;
            pointer-events: auto; /* –∫–ª—ñ–∫–∞–±–µ–ª—å–Ω–∞ */
        }
        .fab-main:active { transform: scale(0.9); }
        .fab-container.active .fab-main {
            transform: rotate(90deg);
            background: var(--accent-red);
            box-shadow: 0 4px 20px rgba(231, 76, 60, 0.5);
        }

        .date-box {
            display: grid;
            grid-template-columns: auto 1fr auto 1fr;
            align-items: center;
            width: 100%;
            margin: 10px 0 18px 0;
            column-gap: 12px;
        }

        .day-title,
        .date-text {
            font-size: 15px;
            font-weight: 600;
            text-transform: uppercase;
            white-space: nowrap;
            letter-spacing: 0.5px;
            text-align: center;
            color: rgba(255,255,255,0.65);
        }

        .date-line {
            width: 100%;
            height: 1px;
            background: rgba(255,255,255,0.18);
        }

        /* —Å–≤—ñ—Ç–ª–∞ —Ç–µ–º–∞ */
        [data-theme="light"] .date-line {
            background: rgba(0,0,0,0.15);
        }

        [data-theme="light"] .day-title,
        [data-theme="light"] .date-text {
            color: rgba(0,0,0,0.65);
        }

        .day-body {
            transition: opacity 0.22s ease, transform 0.25s ease;
        }

        .day-body.slide-left {
            opacity: 0;
            transform: translateX(-40px);
        }

        .day-body.slide-right {
            opacity: 0;
            transform: translateX(40px);
        }


        /* –¢–µ–º–Ω–∞ —Ç–µ–º–∞ */
        [data-theme="dark"] .day-title,
        [data-theme="dark"] .date-text {
            color: rgba(255,255,255,0.65);
        }


        .day-title {
            font-size: 15px;          /* üî• –¢–∞–∫–∏–π —Å–∞–º–∏–π —Ä–æ–∑–º—ñ—Ä —è–∫ —É –¥–∞—Ç–∏ */
            font-weight: 600;
            color: rgba(255,255,255,0.65);   /* üî• –¢–æ–π —Å–∞–º–∏–π –∫–æ–ª—ñ—Ä, —â–æ —É –¥–∞—Ç–∏ */
            text-transform: uppercase;        /* üî• –ö–ê–ü–° */
            white-space: nowrap;
            letter-spacing: 0.5px;   /* üî• –Ø–∫ —É –¥–∞—Ç–∏ */
        }

        .date-text {
            font-size: 15px;
            font-weight: 600;
            color: rgba(255,255,255,0.65);   /* üî• */
            white-space: nowrap;
            letter-spacing: 0.5px;
        }

        /* üî• –ê–Ω—ñ–º–∞—Ü—ñ—è –ø–ª–∞–≤–Ω–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞—Ç–∏ */
        .date-box {
            transition: opacity .25s ease, transform .25s ease;
        }

        .date-box.anim-hide {
            opacity: 0;
            transform: translateX(-20px);
        }

        .date-box.anim-show {
            opacity: 1;
            transform: translateX(0);
        }


        .fab-menu {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
            margin-bottom: 5px;
            pointer-events: none; /* –∞–∫—Ç–∏–≤—É—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –∫–æ–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä active */
        }
        .fab-container.active .fab-menu { pointer-events: auto; }

        .fab-item {
            background: var(--card-bg); color: var(--text-main);
            border: 1px solid rgba(128,128,128,0.15);
            padding: 10px 16px 10px 20px; border-radius: 30px;
            display: flex; align-items: center; justify-content: flex-end; gap: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); cursor: pointer;
            opacity: 0;
            transform: translateY(20px) scale(0.8);
            transform-origin: right bottom;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .fab-container.active .fab-item { opacity: 1; transform: translateY(0) scale(1); }
        .fab-item:active { transform: scale(0.95); background: var(--glass-bg); }

        .fab-text { font-size: 14px; font-weight: 600; }
        .fab-emoji { font-size: 18px; line-height: 1; width: 24px; text-align: center; }

        .fab-item:nth-last-child(1) { transition-delay: 0.05s; }
        .fab-item:nth-last-child(2) { transition-delay: 0.1s;  }
        .fab-item:nth-last-child(3) { transition-delay: 0.15s; }
        .fab-item:nth-last-child(4) { transition-delay: 0.2s;  }
        .fab-item:nth-last-child(5) { transition-delay: 0.25s; }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 99;
            opacity: 0; visibility: hidden; transition: 0.3s; backdrop-filter: blur(5px);
        }
        .modal-overlay.show { opacity: 1; visibility: visible; }

        .queue-list {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: var(--card-bg);
            border-top: 1px solid rgba(128,128,128,0.1);
            border-radius: 24px 24px 0 0;
            padding: 20px; max-height: 70vh; overflow-y: auto;
            transform: translateY(100%); transition: 0.3s;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
        }
        .modal-overlay.show .queue-list { transform: translateY(0); }
        .q-item {
            padding: 16px; margin-bottom: 8px; background: var(--glass-bg);
            border-radius: 12px; text-align: center; font-weight: 600; cursor: pointer; color: var(--text-main);
        }
        .q-item.active { background: #3498db; color: white; }

        /* --- INFO MODAL --- */
        .info-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 100;
            backdrop-filter: blur(5px); opacity: 0; visibility: hidden; transition: 0.3s;
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .info-modal-overlay.show { opacity: 1; visibility: visible; }

        .info-card {
            background: var(--card-bg); border-radius: 20px; padding: 24px;
            width: 100%; max-width: 340px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transform: scale(0.9); transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 1px solid rgba(128,128,128,0.1);
        }
        .info-modal-overlay.show .info-card { transform: scale(1); }

        .info-title { font-size: 20px; font-weight: 800; margin-bottom: 12px; color: var(--text-main); }
        .info-text { font-size: 14px; line-height: 1.6; color: var(--text-muted); margin-bottom: 20px; }
        .info-text a { color: var(--accent-green); text-decoration: none; font-weight: 600; }
        .info-close {
            width: 100%; padding: 12px; border-radius: 12px;
            background: var(--accent-green); color: white;
            font-weight: 700; border: none; cursor: pointer;
        }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .no-data-msg {
            text-align: center; color: var(--text-muted); padding: 30px 20px;
            background: var(--glass-bg); border-radius: 16px; font-size: 15px; margin-top: 12px;
        }
        .offline-badge {
            position: fixed; top: 10px; right: 10px; background: rgba(255, 69, 58, 0.9);
            color: white; padding: 4px 10px; border-radius: 8px; font-size: 11px; z-index: 100;
            font-weight: bold; backdrop-filter: blur(4px);
        }

        /* Skeleton */
        .skeleton-wrapper {
            width: 100%; max-width: 500px; padding: 20px 24px;
            display: flex; flex-direction: column; gap: 20px; margin: 0 auto; margin-top: 20px;
        }
        .skeleton {
            background: linear-gradient(90deg, var(--card-bg) 25%, var(--bg-color) 50%, var(--card-bg) 75%);
            background-size: 200% 100%; animation: shimmer 1.5s infinite linear; border-radius: 16px;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .sk-battery { height: 80px; width: 100%; margin-bottom: 10px; border-radius: 24px; }
        .sk-date { height: 20px; width: 150px; margin: 0 auto; }
        .sk-timeline { height: 60px; width: 100%; }
        .sk-card { height: 80px; width: 100%; }

                /* --- MOBILE FIXES --- */
        @media(max-width: 420px) {

            /* –ú–µ–Ω—à–∏–π —Ç–µ–∫—Å—Ç –∫–æ–ª–æ–Ω–æ–∫ –°–¨–û–ì–û–î–ù–Ü / –ó–ê–í–¢–†–ê */
            .day-title,
            .date-text {
                font-size: 13px !important;
                letter-spacing: 0.3px;
            }

            /* –ó–º–µ–Ω—à–∏—Ç–∏ –≤—ñ–¥—Å—Ç—É–ø–∏ —â–æ–± –≤—Å–µ –±—É–ª–æ –≤ –æ–¥–Ω–æ–º—É —Ä—è–¥–∫—É */
            .date-box {
                column-gap: 6px !important;
                margin: 6px 0 12px !important;
            }

            /* –õ—ñ–Ω—ñ—è —Ç—Ä–æ—Ö–∏ –∫–æ—Ä–æ—Ç—à–∞ */
            .date-line {
                height: 1px;
                opacity: 0.7;
            }

            /* –¢–µ–∫—Å—Ç ‚Äú–ì–†–ê–§–Ü–ö –ù–ê –°–¨–û–ì–û–î–ù–Ü‚Äù –Ω–µ —Ä–æ–∑'—ó–∂–¥–∂–∞—î—Ç—å—Å—è */
            .date-box span {
                white-space: nowrap;
            }

            /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —à–∫–∞–ª–∏ —Ç—Ä–æ—Ö–∏ –±–ª–∏–∂—á–µ –¥–æ –±–∞—Ç–∞—Ä–µ–π–∫–∏ */
            .timeline-section {
                margin-top: -4px !important;
            }

            /* –®—Ä–∏—Ñ—Ç —á–∞—Å—É –ø—ñ–¥ —Å–µ–≥–º–µ–Ω—Ç–∞–º–∏ */
            .t-label {
                font-size: 10px !important;
            }

            /* –©—ñ–ª—å–Ω—ñ—à–µ —Ä–æ–∑—Ç–∞—à–æ–≤–∞–Ω—ñ —Ç—ñ–∫-–º—ñ—Ç–∫–∏ */
            .time-labels {
                margin-top: 4px !important;
            }
        }


    </style>
</head>
<body>

    <div class="top-bar">
        <span class="updated" id="topUpdated">–û–Ω–æ–≤–ª–µ–Ω–æ‚Ä¶</span>
        <span style="flex: 1;"></span>
        <span class="users">
            <span class="icon">üë•</span>
            <span id="topUsers">‚Ä¶</span>
        </span>
    </div>

    <div class="header">
        <div class="queue-select-btn" onclick="toggleModal()">
            <span id="queueTitle">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span>
            <span class="arrow-icon">‚ñº</span>
        </div>
    </div>

    <div id="skeletonLoader" class="skeleton-wrapper">
        <div class="sk-battery skeleton"></div>
        <div class="sk-date skeleton"></div>
        <div class="sk-timeline skeleton"></div>
        <div class="sk-card skeleton"></div>
        <div class="sk-card skeleton"></div>
        <div class="sk-card skeleton"></div>
    </div>

    <div id="app-content" class="hidden">

        <!-- –ë–∞—Ç–∞—Ä–µ–π–∫–∞ (—Å—Ç–∞—Ü—ñ–æ–Ω–∞—Ä–Ω–∞) -->
        <div id="batterySection" class="battery-container">
            <div class="battery-wrapper">
                <div class="battery-shell">
                    <div id="batteryFill" class="battery-fill"></div>
                    <div class="battery-text" id="batteryTimer">--:--</div>
                </div>
                <div class="battery-tip"></div>
            </div>
            <div class="battery-status" id="batteryLabel">—Å—Ç–∞—Ç—É—Å</div>
        </div>


        <!-- üî• –£–≤–µ—Å—å –∫–æ–Ω—Ç–µ–Ω—Ç –¥–Ω—è, —è–∫–∏–π "—Å–ª–∞–π–¥–∏—Ç—å—Å—è" –º—ñ–∂ –°—å–æ–≥–æ–¥–Ω—ñ/–ó–∞–≤—Ç—Ä–∞ -->
        <div id="dayBody" class="day-body">

            <div class="timeline-section" id="timelineSection">
                <div class="timeline-box">
                    <div class="timeline-track" id="timelineTrack"></div>
                    <div class="time-labels" id="timeLabelsBox"></div>
                </div>
                <div id="detailCardContainer" class="detail-card-container hidden"></div>
            </div>

                    <!-- –î–∞—Ç–∞ (—Å—Ç–∞—Ü—ñ–æ–Ω–∞—Ä–Ω–∞) -->

        <div class="date-box">
            <span id="dayTitle" class="day-title">–ì—Ä–∞—Ñ—ñ–∫ –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ</span>
            <div class="date-line"></div>
            <span id="dateDisplay" class="date-text">---</span>
            <div class="date-line"></div>
        </div>

            <div id="emergencyBanner" class="emergency-banner hidden">
                 üö® –ó–∞—Ä–∞–∑ –¥—ñ—é—Ç—å –µ–∫—Å—Ç—Ä–µ–Ω–Ω—ñ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
            </div>

            <div id="noDataMessage" class="no-data-msg hidden">üí§ –ì—Ä–∞—Ñ—ñ–∫ –Ω–∞ —Ü–µ–π –¥–µ–Ω—å —â–µ –Ω–µ —Å—Ñ–æ—Ä–º–æ–≤–∞–Ω–æ</div>

            <div class="card-list" id="infoBox"></div>

            <div style="text-align:center;">
                <div class="total-block" id="totalBox"></div>
            </div>

            <div id="shareWrapper" class="share-wrapper hidden">
                <button class="share-btn" onclick="shareSchedule()">üîó –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è –≥—Ä–∞—Ñ—ñ–∫–æ–º</button>
            </div>


            <div class="donate-wrapper">
                <a href="https://send.monobank.ua/jar/6qoHuhpGgD" target="_blank" class="donate-btn">
                    <div class="donate-progress" id="donateProgress"></div>
                    <div class="donate-content">
                        <div class="donate-title">
                            <span>üîå</span> <span>–ü—ñ–¥–∑–∞—Ä—è–¥–∏—Ç–∏ –±–æ—Ç–∞</span>
                        </div>
                        <div class="donate-amount" id="donateAmount">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
                    </div>
                </a>
            </div>

        </div> <!-- /dayBody -->

        <div id="emergencyOverlay" class="emergency-overlay" onclick="closeEmergency()">
            <div class="emergency-box" onclick="event.stopPropagation()">
                <div class="emergency-title">üö® –ï–ö–°–¢–†–ï–ù–Ü –í–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø</div>
                <div class="emergency-text">
                    –í–∞—à–µ —Å–≤—ñ—Ç–ª–æ –º–æ–∂—É—Ç—å –≤–∏–º–∫–Ω—É—Ç–∏ –±—É–¥—å-–∫–æ–ª–∏, –Ω–µ–∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –≥—Ä–∞—Ñ—ñ–∫—É.
                </div>
                <button class="emergency-btn" onclick="closeEmergency()">–ó—Ä–æ–∑—É–º—ñ–ª–æ</button>
            </div>
        </div>


    </div> <!-- /app-content -->

    <div class="modal-overlay" id="modal" onclick="toggleModal()">
        <div class="queue-list" id="queueList" onclick="event.stopPropagation()"></div>
    </div>

    <div class="tab-bar">
        <div class="tab-item active" id="tab1" onclick="switchTab(1)">–°—å–æ–≥–æ–¥–Ω—ñ</div>
        <div class="tab-item" id="tab2" onclick="switchTab(2)">–ó–∞–≤—Ç—Ä–∞</div>
    </div>

    <div class="fab-overlay" id="fabOverlay" onclick="toggleFab()"></div>

    <div class="fab-container" id="fabContainer">
        <div class="fab-menu">

            <div class="fab-item" onclick="showInfo('about')">
                <span class="fab-text">–ü—Ä–æ –±–æ—Ç–∞</span>
                <span class="fab-emoji">ü§ñ</span>
            </div>

            <div class="fab-item" onclick="showInfo('collab')">
                <span class="fab-text">–°–ø—ñ–≤–ø—Ä–∞—Ü—è</span>
                <span class="fab-emoji">ü§ù</span>
            </div>

            <div class="fab-item" onclick="showInfo('queue')">
                <span class="fab-text">–ß–µ—Ä–≥–∞</span>
                <span class="fab-emoji">‚ùì</span>
            </div>

            <div class="fab-item" onclick="showInfo('faq')">
                <span class="fab-text">–ü–∏—Ç–∞–Ω–Ω—è-–≤—ñ–¥–ø–æ–≤—ñ–¥—ñ</span>
                <span class="fab-emoji">üí¨</span>
            </div>

            <div class="fab-item" onclick="showInfo('emergency')">
                <span class="fab-text">–ê–≤–∞—Ä—ñ–π–Ω—ñ —Å–ª—É–∂–±–∏</span>
                <span class="fab-emoji">üö®</span>
            </div>

            <div class="fab-item" onclick="showInfo('support')">
                <span class="fab-text">–î–æ–Ω–∞—Ç</span>
                <span class="fab-emoji">üíö</span>
            </div>

            <div class="fab-item" onclick="toggleTheme()" id="fabThemeBtnBlock">
                <span class="fab-text">–¢–µ–º–∞</span>
                <span class="fab-emoji" id="fabThemeIcon">üåô</span>
            </div>
        </div>

        <div class="fab-main" onclick="toggleFab()">
            <span class="fab-icon">‚ò∞</span>
        </div>
    </div>

    <div class="info-modal-overlay" id="infoModal" onclick="closeInfo()">
        <div class="info-card" onclick="event.stopPropagation()">
            <div class="info-title" id="infoTitle"></div>
            <div class="info-text" id="infoText"></div>
            <button class="info-close" onclick="closeInfo()">–ó—Ä–æ–∑—É–º—ñ–ª–æ</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        function getUrlParam(name) {
            const url = new URL(window.location.href);
            return url.searchParams.get(name);
        }

        (function applyStartAppData() {
            let param = null;
            const fromUrl = getUrlParam("startapp");
            if (fromUrl) param = fromUrl;
            if (!param) param = tg.initDataUnsafe?.start_param;
            if (!param) return;

            try {
                const json = JSON.parse(atob(param.replace(/-/g, '+').replace(/_/g, '/')));
                if (json.updated) document.getElementById("topUpdated").innerText = "–û–Ω–æ–≤–ª–µ–Ω–æ: " + json.updated;
                if (json.users_total || json.users) {
                    const raw = json.users_total || json.users;
                    const clean = formatUsersNumber(raw);
                    document.getElementById("topUsers").innerText = clean;
                    window.STARTAPP_USERS = clean;
                }
                if (json.queue) {
                    currentQueue = json.queue;
                    localStorage.setItem('savedQueue', json.queue);
                }
            } catch (err) { console.error(err); }
        })();

        const CSV_PROXY_URL = "https://shy-fog-bb74svitlo-proxy.propro3107.workers.dev";
        let allData = [];
        let currentQueue = "1.1";
        let currentTab = 1;
        let countdownInterval;
        let activeSegmentElement = null;
        let activeListCard = null;
        let cursor = null;

        function ensureCursor() {
            if (!cursor) {
                cursor = document.createElement('div');
                cursor.id = 'cursor';
                cursor.className = 'cursor-line';
            }
        }

        // –∞–≤—Ç–æ–æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö
        setInterval(() => init(true), 120000);

        async function getCSV(retries = 1) {
            const url = `${CSV_PROXY_URL}?t=${Date.now()}`;
            try {
                const r = await fetch(url, { cache: "no-cache" });
                if (!r.ok) throw new Error("Bad status " + r.status);
                return await r.text();
            } catch (e) {
                if (retries > 0) return getCSV(retries - 1);
                throw e;
            }
        }

        function showEmergency() {
            document.getElementById("emergencyOverlay").classList.add("show");
        }

        function closeEmergency() {
            document.getElementById("emergencyOverlay").classList.remove("show");
            localStorage.setItem("emergency_ack", "1"); // —â–æ–± –Ω–µ –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ
        }


        async function init(isSilent = false) {
            loadTheme();

            try {
                if (!isSilent) {
                    const sk = document.getElementById('skeletonLoader');
                    if (sk) sk.classList.remove('hidden');
                    document.getElementById('app-content').classList.add('hidden');
                }

                const csvText = await getCSV();
                allData = parseCSV(csvText);

                // global emergency flag from first row
                const primary = normalizeHeaders(allData[0]);

                if (primary.emergency === "on") {

                    document.getElementById("emergencyBanner").classList.remove("hidden");
                
                    const ack = localStorage.getItem("emergency_ack");

                    if (!ack) {
                        // –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–ª–∞—à–∫—É —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥–∏ –ø—ñ—Å–ª—è –∑–∞–ø—É—Å–∫—É
                        setTimeout(() => {
                            showEmergency();
                        }, 3000);
                    }

                } else {

                    document.getElementById("emergencyBanner").classList.add("hidden");
                    localStorage.removeItem("emergency_ack");
                }

                window.LAST_UPDATED = null;
                for (const row of allData) {
                    if (row.updated_at && row.updated_at.trim() !== "") {
                        window.LAST_UPDATED = row.updated_at.trim();
                        break;
                    }
                }

                updateTopUpdated();

                if (!allData.length) throw new Error("Empty Data");

                localStorage.setItem('cachedData', JSON.stringify(allData));
                removeOfflineBadge();

                const sk = document.getElementById('skeletonLoader');
                if (sk) sk.classList.add('hidden');

                setupApp(isSilent);

                const row = allData.find(r => r.group_id == currentQueue);
                if (row) {
                    const cleanRow = normalizeHeaders(row);
                    let u = cleanRow.users_total || cleanRow.users;
                    if (!u && allData.length > 0) {
                        const primary = normalizeHeaders(allData[0]);
                        u = primary.users_total || primary.users;
                    }
                    if (u) updateTopUsers(formatUsersNumber(u));
                }

                if (window.STARTAPP_USERS) {
                    updateTopUsers(window.STARTAPP_USERS);
                }

            } catch (e) {
                console.error("Online fetch error:", e);
                const cached = localStorage.getItem('cachedData');

                if (cached) {
                    allData = JSON.parse(cached);
                    showOfflineBadge();
                    window.LAST_UPDATED = null;
                    for (const row of allData) {
                        if (row.updated_at && row.updated_at.trim() !== "") {
                            window.LAST_UPDATED = row.updated_at.trim();
                            break;
                        }
                    }
                    updateTopUpdated();
                    const sk = document.getElementById('skeletonLoader');
                    if (sk) sk.classList.add('hidden');
                    setupApp(isSilent);
                    if (window.STARTAPP_USERS) updateTopUsers(window.STARTAPP_USERS);
                }
            }
        }

        function setupApp(isSilent) {
            const p = new URLSearchParams(window.location.search);
            let q = p.get('q');
            if (q) {
                currentQueue = q;
                localStorage.setItem("savedQueue", q);
            } else {
                const saved = localStorage.getItem("savedQueue");
                if (saved) currentQueue = saved;
            }
            if (!isSilent) {
                buildMenu();
                const appContent = document.getElementById('app-content');
                if (appContent) appContent.classList.remove('hidden');
            }
            render(currentTab);
        }

        function showOfflineBadge() {
            if (!document.getElementById('offBadge')) {
                const b = document.createElement('div');
                b.id = 'offBadge'; b.className = 'offline-badge';
                b.innerText = 'Offline';
                document.body.appendChild(b);
            }
        }
        function removeOfflineBadge() { const b = document.getElementById('offBadge'); if (b) b.remove(); }
        function formatUsersNumber(v) { v = String(v).replace(/\s+/g, ""); return v.replace(/\B(?=(\d{3})+(?!\d))/g, " "); }

        function parseCSV(text) {
            const rows = []; let currentRow = []; let currentVal = ''; let insideQuotes = false;
            for (let i = 0; i < text.length; i++) {
                const char = text[i]; const nextChar = text[i + 1];
                if (char === '"') {
                    if (insideQuotes && nextChar === '"') { i++; currentVal += '"'; }
                    else { insideQuotes = !insideQuotes; }
                }
                else if (char === ',' && !insideQuotes) {
                    currentRow.push(currentVal); currentVal = '';
                }
                else if ((char === '\r' || char === '\n') && !insideQuotes) {
                    if (char === '\r' && nextChar === '\n') i++;
                    if (currentVal || currentRow.length) currentRow.push(currentVal);
                    if (currentRow.length) rows.push(currentRow);
                    currentRow = []; currentVal = '';
                } else { currentVal += char; }
            }
            if (currentVal || currentRow.length) currentRow.push(currentVal);
            if (currentRow.length) rows.push(currentRow);
            if (rows.length < 2) return [];
            const rawHeaders = rows[0].map(h => h.replace(/\uFEFF/g, '').replace(/\u00A0/g, ' ').replace(/[\u200B-\u200F]/g, '').trim().toLowerCase());
            return rows.slice(1).map(row => {
                const obj = {};
                rawHeaders.forEach((h, i) => {
                    let val = row[i] ?? "";
                    if (val.startsWith('"') && val.endsWith('"')) val = val.slice(1, -1);
                    obj[h] = val.trim();
                });
                return obj;
            });
        }

        function normalizeHeaders(obj) {
            const fixed = {};
            for (let key in obj) {
                const clean = key.replace(/\uFEFF/g, "").replace(/\u00A0/g, " ").replace(/[\u200B-\u200F]/g, "").trim().toLowerCase();
                fixed[clean] = obj[key];
            }
            return fixed;
        }

        function getSchedule(fullText, targetDate) {
            if (!fullText) return null;
            const daysMap = ["–ù–µ–¥—ñ–ª—è", "–ü–æ–Ω–µ–¥—ñ–ª–æ–∫", "–í—ñ–≤—Ç–æ—Ä–æ–∫", "–°–µ—Ä–µ–¥–∞", "–ß–µ—Ç–≤–µ—Ä", "–ü º—è—Ç–Ω–∏—Ü—è", "–°—É–±–æ—Ç–∞"];
            const dayName = daysMap[targetDate.getDay()];
            const lines = fullText.replace(/\r\n/g, '\n').split('\n');
            let dayLine = lines.find(line => line.trim().startsWith(dayName));
            if (!dayLine || dayLine.includes(":-") || dayLine.includes(": -") || dayLine.trim().endsWith("-")) return null;
            let timesPart = dayLine.includes(':') ? dayLine.substring(dayLine.indexOf(':') + 1).trim() : "";
            if (!timesPart || timesPart === "-") return null;
            timesPart = timesPart.replace(/\+/g, "");
            const ranges = timesPart.split(',');
            let arr = []; let lastTime = 0;
            ranges.forEach(r => {
                const parts = r.split('-').map(s => s.trim());
                if (parts.length < 2) return;
                const startH = timeToH(parts[0]); const endH = timeToH(parts[1]);
                if (isNaN(startH) || isNaN(endH)) return;
                if (startH > lastTime) arr.push(`${parseFloat((startH - lastTime).toFixed(2))}on`);
                let dur = endH - startH;
                if (endH < startH) dur = 24 - startH;
                if (dur > 0) arr.push(`${parseFloat(dur.toFixed(2))}off`);
                lastTime = (endH >= startH) ? endH : 24;
            });
            if (lastTime < 24) arr.push(`${parseFloat((24 - lastTime).toFixed(2))}on`);
            if (arr.length === 0) return "24on";
            return arr.join(',');
        }

        function timeToH(t) { const [h, m] = t.split(':').map(Number); return h + (m / 60); }

        function toggleModal() {
            const modal = document.getElementById('modal');
            modal.classList.toggle('show');

            // –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è —Å—Ç—Ä—ñ–ª–æ—á–∫–∏ ‚ñº
            document.querySelector('.queue-select-btn').classList.toggle('open');

            // –Ø–∫—â–æ –º–æ–¥–∞–ª–∫–∞ –≤—ñ–¥–∫—Ä–∏–ª–∞—Å—å ‚Äî —á–µ—Ä–µ–∑ 150 –º—Å –∑–∞–ª–∏–ø–∞—î–º–æ –Ω–∞ –∞–∫—Ç–∏–≤–Ω—É —á–µ—Ä–≥—É
            if (modal.classList.contains('show')) {
                setTimeout(scrollToActiveQueue, 150);
            }
        }


        function selectQueue(q) {
            currentQueue = q; localStorage.setItem('savedQueue', q);
            try { tg.HapticFeedback.selectionChanged(); } catch (e) { }
            toggleModal(); buildMenu(); render(currentTab);
        }

        function buildMenu() {
            const list = document.getElementById('queueList');
            list.innerHTML = '<div style="text-align:center;margin-bottom:15px;color:var(--text-muted);font-size:12px">–û–ë–ï–†–Ü–¢–¨ –ß–ï–†–ì–£</div>';
            const queues = [...new Set(allData.map(i => i.group_id))].sort();
            queues.forEach(q => {
                if (!q) return;
                let d = document.createElement('div');
                d.className = `q-item ${q == currentQueue ? 'active' : ''}`;
                d.innerText = `–ß–µ—Ä–≥–∞ ${q}`;
                d.onclick = () => selectQueue(q);
                list.appendChild(d);
            });
            document.getElementById('queueTitle').innerText = `–ß–ï–†–ì–ê ${currentQueue}`;
        }

        function formatUpdateTime(raw) {
            if (!raw) return "";
            const months = ["—Å—ñ—á–Ω—è","–ª—é—Ç–æ–≥–æ","–±–µ—Ä–µ–∑–Ω—è","–∫–≤—ñ—Ç–Ω—è","—Ç—Ä–∞–≤–Ω—è","—á–µ—Ä–≤–Ω—è","–ª–∏–ø–Ω—è","—Å–µ—Ä–ø–Ω—è","–≤–µ—Ä–µ—Å–Ω—è","–∂–æ–≤—Ç–Ω—è","–ª–∏—Å—Ç–æ–ø–∞–¥–∞","–≥—Ä—É–¥–Ω—è"];
            const [datePart, timePart] = raw.split(" ");
            const [Y, M, D] = datePart.split("-").map(Number);
            const [h, m] = timePart.split(":").map(Number);
            const dt = new Date(Y, M - 1, D, h, m);
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today); yesterday.setDate(yesterday.getDate() - 1);
            const dayOnly = new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());
            if (dayOnly.getTime() === today.getTime()) return `–û–Ω–æ–≤–ª–µ–Ω–æ: —Å—å–æ–≥–æ–¥–Ω—ñ –æ ${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
            if (dayOnly.getTime() === yesterday.getTime()) return `–û–Ω–æ–≤–ª–µ–Ω–æ: –≤—á–æ—Ä–∞ –æ ${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
            return `–û–Ω–æ–≤–ª–µ–Ω–æ: ${D} ${months[M-1]} –æ ${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
        }

        // üî• MODE C SLIDE: —Å–ª–∞–π–¥–∏—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ dayBody, –±–∞—Ç–∞—Ä–µ–π–∫–∞/–¥–∞—Ç–∞ —Å—Ç–æ—è—Ç—å
        function switchTab(idx) {
            if (currentTab === idx) return;

            try { tg.HapticFeedback.impactOccurred('light'); } catch (e) {}

            const body = document.getElementById("dayBody");
            const dateBox = document.querySelector(".date-box");

            // –∞–Ω—ñ–º–∞—Ü—ñ—è –¥–∞—Ç–∏
            dateBox.classList.add("anim-hide");

            const direction = idx > currentTab ? 1 : -1;
            // 1 ‚Üí –∑–∞—ó–∑–¥ —Å–ø—Ä–∞–≤–∞ (—Å—å–æ–≥–æ–¥–Ω—ñ ‚Üí –∑–∞–≤—Ç—Ä–∞)
            // -1 ‚Üí –∑–∞—ó–∑–¥ –∑–ª—ñ–≤–∞  (–∑–∞–≤—Ç—Ä–∞ ‚Üí —Å—å–æ–≥–æ–¥–Ω—ñ)

            // outgoing animation
            body.style.transition = "transform .25s ease, opacity .25s ease";
            body.style.transform = `translateX(${-40 * direction}px)`;
            body.style.opacity = "0";

            setTimeout(() => {
                currentTab = idx;

                document.querySelectorAll('.tab-item')
                    .forEach(t => t.classList.remove('active'));
                document.getElementById("tab" + idx).classList.add("active");

                // —Å—Ç–∞–≤–∏–º–æ –Ω–æ–≤–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç –ó –ü–†–û–¢–ò–õ–ï–ñ–ù–û–ì–û –±–æ–∫—É
                body.style.transition = "none";
                body.style.transform = `translateX(${40 * direction}px)`;
                body.style.opacity = "0";

                render(idx);

                // —ñ –≤'—ó–∂–¥–∂–∞—î–º–æ
                setTimeout(() => {
                    body.style.transition = "transform .25s ease, opacity .25s ease";
                    body.style.transform = "translateX(0)";
                    body.style.opacity = "1";

                    // –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ –¥–∞—Ç—É
                    setTimeout(() => {
                        dateBox.classList.remove("anim-hide");
                        dateBox.classList.add("anim-show");
                        setTimeout(() => dateBox.classList.remove("anim-show"), 250);
                    }, 40);

                }, 20);

            }, 250);
        }





        function setupTomorrowBattery(scheduleStr) {
            const batSec = document.getElementById('batterySection');
            const timerEl = document.getElementById('batteryTimer');
            const labelEl = document.getElementById('batteryLabel');
            const f = document.getElementById('batteryFill');

            batSec.classList.remove('hidden');
            clearInterval(countdownInterval);

            const parts = scheduleStr.split(',');
            let h = 0;
            let firstOffStart = null;

            for (const p of parts) {
                const type = p.includes('off') ? 'off' : 'on';
                const dur = parseFloat(p);
                if (isNaN(dur) || dur <= 0) continue;
                const start = h;
                const end = h + dur;

                if (type === 'off' && firstOffStart === null) {
                    firstOffStart = start;
                    break;
                }
                h = end;
            }

            // —î –ø–µ—Ä—à–µ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –∑–∞–≤—Ç—Ä–∞
            if (firstOffStart != null) {
                const now = new Date();
                const nowFloat = now.getHours() + now.getMinutes() / 60 + now.getSeconds() / 3600;

                const targetH = 24 + firstOffStart; // –∑–∞–≤—Ç—Ä–∞
                let totalSec = Math.round((targetH - nowFloat) * 3600);
                if (totalSec < 60) totalSec = 60;

                // —Å—Ç–∞—Ä—Ç—É—î–º–æ —Ç–∞–π–º–µ—Ä —è–∫ "–¥–æ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è"
                startTimer(targetH, totalSec, true);
            } else {
                // –∑–∞–≤—Ç—Ä–∞ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å –Ω–µ–º–∞—î
                timerEl.innerText = "--:--";
                labelEl.innerText = "–°–≤—ñ—Ç–ª–æ —Ü—ñ–ª–∏–π –¥–µ–Ω—å";
                f.classList.remove('discharging');
                f.style.width = "100%";
                f.style.background = "linear-gradient(90deg, #1abc9c, #2ecc71)";
                f.style.boxShadow = "0 0 15px #2ecc71";
            }
        }

        function render(dayIdx) {
            const row = allData.find(r => r.group_id == currentQueue);
            if (!row) return;

            const targetDate = new Date();
            if (dayIdx === 2) targetDate.setDate(targetDate.getDate() + 1);

            const scheduleStr = getSchedule(row.schedule_text, targetDate);

            const d = String(targetDate.getDate()).padStart(2, '0');
            const m = String(targetDate.getMonth() + 1).padStart(2, '0');
            const daysMap = ["–ù–ï–î–Ü–õ–Ø", "–ü–û–ù–ï–î–Ü–õ–û–ö", "–í–Ü–í–¢–û–†–û–ö", "–°–ï–†–ï–î–ê", "–ß–ï–¢–í–ï–†", "–ü º–Ø–¢–ù–ò–¶–Ø", "–°–£–ë–û–¢–ê"];
            document.getElementById('dateDisplay').innerText = `${daysMap[targetDate.getDay()]} ${d}.${m}`;

            const track   = document.getElementById('timelineTrack');
            const iBox    = document.getElementById('infoBox');
            const lBox    = document.getElementById('timeLabelsBox');
            const tlSec   = document.getElementById('timelineSection');
            const totBox  = document.getElementById('totalBox');
            const noData  = document.getElementById('noDataMessage');
            const batSec  = document.getElementById('batterySection');
            const detailBox = document.getElementById('detailCardContainer');

            // –æ—á–∏—â–µ–Ω–Ω—è
            track.innerHTML = '';
            while (lBox.firstChild) lBox.removeChild(lBox.firstChild);
            iBox.innerHTML = '';
            detailBox.innerHTML = '';
            detailBox.classList.add('hidden');
            activeSegmentElement = null; activeListCard = null; clearInterval(countdownInterval);

            ensureCursor();
            track.appendChild(cursor);
            cursor.style.display = (dayIdx === 1 ? 'block' : 'none');

            const isToday = (dayIdx === 1);
            document.getElementById("dayTitle").innerText =
                isToday ? "–ì—Ä–∞—Ñ—ñ–∫ –Ω–∞ —Å—å–æ–≥–æ–¥–Ω—ñ" : "–ì—Ä–∞—Ñ—ñ–∫ –Ω–∞ –∑–∞–≤—Ç—Ä–∞";

            const bf = document.getElementById('batteryFill');
            bf.className = 'battery-fill'; // —Å–∫–∏–¥–∞—Ç–∏ —Å—ñ—Ä–∏–π —Ä–µ–∂–∏–º

            // –ù–µ–º–∞—î –≥—Ä–∞—Ñ—ñ–∫–∞ –Ω–∞ –¥–µ–Ω—å
            if (!scheduleStr) {
                tlSec.classList.add('hidden');
                noData.classList.remove('hidden');
                totBox.innerHTML = '';

                batSec.classList.remove('hidden');
                bf.className = 'battery-fill';

                if (isToday) {
                    // –°—å–æ–≥–æ–¥–Ω—ñ –±–µ–∑ –≥—Ä–∞—Ñ—ñ–∫–∞
                    document.getElementById('batteryTimer').innerText = "‚Äî";
                    document.getElementById('batteryLabel').innerText = "–ù–µ–≤—ñ–¥–æ–º–æ";
                } else {
                    // üî• –ó–∞–≤—Ç—Ä–∞ –±–µ–∑ –≥—Ä–∞—Ñ—ñ–∫–∞ ‚Üí –î–£–ë–õ–Æ–Ñ–ú–û –±–∞—Ç–∞—Ä–µ–π–∫—É —Å—å–æ–≥–æ–¥–Ω—ñ
                    const t = document.getElementById('batteryTimer').innerText;
                    const l = document.getElementById('batteryLabel').innerText;
                    const fNow = document.querySelector('.battery-fill');

                    document.getElementById('batteryTimer').innerText = t;
                    document.getElementById('batteryLabel').innerText = l;

                    bf.style.width = fNow.style.width;
                    bf.style.background = fNow.style.background;
                    bf.style.boxShadow = fNow.style.boxShadow;
                }
                return;
            }

            // –Ñ –≥—Ä–∞—Ñ—ñ–∫
            tlSec.classList.remove('hidden');
            noData.classList.add('hidden');

            if (!isToday) {
                // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –¢–û–ô –°–ê–ú–ò–ô —á–∞—Å, —â–æ —ñ —Å—å–æ–≥–æ–¥–Ω—ñ
                const t = document.getElementById('batteryTimer').innerText;
                const l = document.getElementById('batteryLabel').innerText;
                const f = document.getElementById('batteryFill');

                document.getElementById('batteryTimer').innerText = t;
                document.getElementById('batteryLabel').innerText = l;

                // –∑–∞–ª–∏–≤–∫–∞ —Ç–∞–∫–∞ —Å–∞–º–∞
                f.style.width = document.querySelector('.battery-fill').style.width;
            }


            let curH = 0; let totOff = 0;
            const now = new Date();
            const curFloat = now.getHours() + now.getMinutes() / 60 + now.getSeconds() / 3600;
            let foundState = false;
            let lastEndH = 0;
            let finalEndLabel = "24:00";

            addLabel(lBox, 0, "00:00", "start");

            const parts = scheduleStr.split(',');
            parts.forEach((part, index) => {
                let type = part.includes('off') ? 'off' : 'on';
                let dur = parseFloat(part.replace('on', '').replace('off', ''));
                if (isNaN(dur) || dur <= 0) return;
                let segStart = curH;
                let endH = curH + dur;
                let realTimerTarget = endH;
                let displayEndH = endH;

                if (index === parts.length - 1 && Math.abs(endH - 24) < 0.1) {
                    const tomorrowDate = new Date(targetDate);
                    tomorrowDate.setDate(tomorrowDate.getDate() + 1);
                    const tomorrowSchedule = getSchedule(row.schedule_text, tomorrowDate);
                    if (tomorrowSchedule) {
                        const firstPart = tomorrowSchedule.split(',')[0];
                        const nextType = firstPart.includes('off') ? 'off' : 'on';
                        const nextDur = parseFloat(firstPart.replace('on', '').replace('off', ''));
                        if (nextType === type) {
                            realTimerTarget = 24 + nextDur;
                            displayEndH = nextDur;
                            finalEndLabel = formatHM(displayEndH);
                        }
                    }
                }

                let seg = document.createElement('div');
                seg.className = `segment ${type}`;
                seg.style.flexGrow = dur;
                seg.style.flexBasis = '0';
                if (dur >= 1.5) seg.innerHTML = `<div class="segment-icon">${type === 'on' ? 'üí°' : 'üîå'}</div>`;
                track.appendChild(seg);
                seg.addEventListener('click', () => handleSegmentClick(seg, type, segStart, endH, dur));

                if (endH < 23.9 && (endH - lastEndH) > 2.0 && (24 - endH) > 1.5) {
                    addLabel(lBox, endH, formatHM(endH), "mid");
                    lastEndH = endH;
                }

                let cardEndText = (displayEndH !== endH) ? displayEndH : endH;
                let cardDur = dur;
                if (realTimerTarget > 24) cardDur += (realTimerTarget - 24);
                let card = createCard(segStart, cardEndText, cardDur, type);
                if (isToday && curFloat >= segStart && curFloat < endH) card.classList.add('active-now');
                iBox.appendChild(card);

                if (type === 'off') totOff += dur;

                if (isToday && !foundState && curFloat < endH) {
                    foundState = true;
                    let totalSecForBat = dur * 3600;
                    if (realTimerTarget > 24) totalSecForBat = cardDur * 3600;
                    startTimer(realTimerTarget, totalSecForBat, type === 'on');
                }
                curH = endH;
            });

            addLabel(lBox, 24, finalEndLabel, "end");

            if (isToday && !foundState) {
                document.getElementById('batteryTimer').innerText = "--:--";
                setBat(0, true);
            }

            totBox.innerHTML = `–í—Å—å–æ–≥–æ –±–µ–∑ —Å–≤—ñ—Ç–ª–∞: <b>${fmtDur(totOff)}</b>`;

            // –ø–æ–∫–∞–∑–∞—Ç–∏ –∫–Ω–æ–ø–∫—É "–ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è –≥—Ä–∞—Ñ—ñ–∫–æ–º"
            const shareWrap = document.getElementById("shareWrapper");
            shareWrap.classList.remove("hidden");

            // –∞–Ω—ñ–º–∞—Ü—ñ—è —Ç—ñ–ª—å–∫–∏ –ø—Ä–∏ –ø–µ—Ä—à—ñ–π –ø–æ—è–≤—ñ
            if (!shareWrap.classList.contains("fade-in")) {
                setTimeout(() => shareWrap.classList.add("fade-in"), 150);
            }
            
        }

        function handleSegmentClick(segEl, type, startH, endH, dur) {
            const detailBox = document.getElementById('detailCardContainer');
            if (activeSegmentElement === segEl) {
                segEl.classList.remove('segment-selected');
                activeSegmentElement = null;
                const card = detailBox.querySelector('.detail-card');
                if (card) {
                    card.classList.add('closing');
                    setTimeout(() => { detailBox.classList.add('hidden'); detailBox.innerHTML = ''; }, 280);
                } else { detailBox.classList.add('hidden'); detailBox.innerHTML = ''; }
                return;
            }
            if (activeSegmentElement) activeSegmentElement.classList.remove('segment-selected');
            activeSegmentElement = segEl;
            segEl.classList.add('segment-selected');
            showDetailCard(type === 'on' ? 'on' : 'off', startH, endH, dur);
            try { tg.HapticFeedback.selectionChanged(); } catch (e) { }
        }

        function showDetailCard(type, startH, endH, durH) {
            const box = document.getElementById('detailCardContainer');
            if (!box) return;
            const startStr = formatHM(startH);
            const endStr = formatHM(endH);
            const durStr = fmtDur(durH);
            let titleStatus, icon, headerClass, bodyHtml;
            if (type === 'on') {
                titleStatus = '–°–í–Ü–¢–õ–û –Ñ'; icon = 'üí°'; headerClass = 'detail-status-on';
                bodyHtml = `<p>–°–≤—ñ—Ç–ª–æ –±—É–¥–µ –∑ <b>${startStr}</b> –¥–æ <b>${endStr}</b>.</p><p>–ù–∞—Å—Ç—É–ø–Ω–µ –≤–∏–º–∫–Ω–µ–Ω–Ω—è –æ—á—ñ–∫—É—î—Ç—å—Å—è –æ <b>${endStr}</b>.</p>`;
            } else {
                titleStatus = '–í–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø'; icon = 'üîå'; headerClass = 'detail-status-off';
                bodyHtml = `<p>–°–≤—ñ—Ç–ª–æ –±—É–¥–µ –≤–∏–º–∫–Ω–µ–Ω–µ –æ <b>${startStr}</b> —ñ –ø–æ–≤–µ—Ä–Ω–µ—Ç—å—Å—è –æ <b>${endStr}</b>.</p><p>–ü–ª–∞–Ω–æ–≤–µ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è.</p>`;
            }
            box.classList.remove('hidden');
            box.innerHTML = `
                <div class="detail-card ${type === 'on' ? 'on' : 'off'}">
                    <div class="detail-header">
                        <div class="detail-left">
                            <div class="detail-icon">${icon}</div>
                            <div class="detail-main">
                                <div class="detail-status ${headerClass}">${titleStatus}</div>
                                <div class="detail-time">${startStr} - ${endStr}</div>
                            </div>
                        </div>
                        <div class="detail-duration">${durStr}</div>
                    </div>
                    <div class="detail-divider"></div>
                    <div class="detail-body">
                        ${bodyHtml}
                        <p class="detail-note">* –í–∫–ª—é—á–µ–Ω–Ω—è/–≤–∏–º–∫–Ω–µ–Ω–Ω—è –º–æ–∂–µ –≤—ñ–¥–±—É–≤–∞—Ç–∏—Å—è –∑ –Ω–µ–≤–µ–ª–∏–∫–æ—é –ø–æ—Ö–∏–±–∫–æ—é —É —á–∞—Å—ñ.</p>
                    </div>
                </div>`;
        }

        function addLabel(box, h, txt, align) {
            let el = document.createElement('div');
            el.className = `t-label ${align}`;
            el.innerText = txt;
            el.style.left = (h / 24 * 100) + "%";
            let t = document.createElement('div');
            t.className = 't-tick';
            el.appendChild(t);
            box.appendChild(el);
        }

        function updateTopUsers(val) { const el = document.getElementById("topUsers"); if (el) el.innerText = val; }
        function updateCursor() { if (currentTab !== 1 || !cursor) return; const d = new Date(); const m = d.getHours() * 60 + d.getMinutes(); let p = m / 1440 * 100; if (p > 100) p = 100; cursor.style.left = p + "%"; }
        function updateTopUpdated() { const el = document.getElementById("topUpdated"); if (!el) return; if (window.LAST_UPDATED) { el.innerText = formatUpdateTime(window.LAST_UPDATED); } else { el.innerText = "–û–Ω–æ–≤–ª–µ–Ω–æ‚Ä¶"; } }

        function startTimer(targetH, totalSec, isOn) {
            clearInterval(countdownInterval);
            const n = new Date();
            const tH = Math.floor(targetH);
            const tM = Math.round((targetH - tH) * 60);
            const tD = new Date();
            tD.setHours(tH, tM, 0, 0);
            if (tD < n) tD.setDate(tD.getDate() + 1);

            function tick() {
                const now = new Date();
                const rem = Math.floor((tD - now) / 1000);
                updateCursor();
                if (rem <= 0) { clearInterval(countdownInterval); setTimeout(() => render(currentTab), 1000); return; }
                document.getElementById('batteryTimer').innerText = fmtTimer(rem);
                setBat(rem / totalSec, isOn);
            }
            tick();
            countdownInterval = setInterval(tick, 1000);
        }

        function setBat(pct, isOn) {
            pct = Math.min(Math.max(pct, 0), 1);
            const f = document.getElementById('batteryFill');
            const label = document.getElementById('batteryLabel');
            const tip = document.querySelector('.battery-tip');

            let visualPct, hue;
            if (isOn) {
                visualPct = pct; hue = pct * 120;
                f.classList.add('discharging');
            } else {
                visualPct = 1 - pct; hue = (visualPct * visualPct) * 120;
                f.classList.remove('discharging');
            }
            f.style.width = Math.max(visualPct * 100, 5) + "%";
            label.innerText = isOn ? '–¥–æ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è' : '–¥–æ –≤–∫–ª—é—á–µ–Ω–Ω—è';

            const colorStart = `hsl(${hue}, 100%, 35%)`;
            const colorEnd   = `hsl(${hue}, 100%, 60%)`;
            const mainColor  = `hsl(${hue}, 100%, 45%)`;

            f.style.background = `linear-gradient(90deg, ${colorStart}, ${colorEnd})`;
            f.style.boxShadow  = `0 0 15px ${mainColor}`;

            if(tip) {
                tip.style.background = mainColor;
                tip.style.boxShadow  = `0 0 10px ${mainColor}`;
            }
        }

        function createCard(s, e, d, type) {
            let c = document.createElement('div');
            c.className = `card c-${type}`;
            c.innerHTML = `
                <div class="card-header">
                    <div class="card-info">
                        <div class="c-icon">${type==='on'?'üí°':'üîå'}</div>
                        <div class="c-times">
                            <div class="status-label">${type==='on'?'–°–í–Ü–¢–õ–û –Ñ':'–í–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø'}</div>
                            <div class="c-time">${formatHM(s)} - ${formatHM(e)}</div>
                        </div>
                    </div>
                    <div class="c-dur">${fmtDur(d)}</div>
                </div>
                <div class="card-details">
                    ${
                        type==='on'
                        ? `–°–≤—ñ—Ç–ª–æ –±—É–¥–µ –∑ <b>${formatHM(s)}</b> –¥–æ <b>${formatHM(e)}</b>.<br>–ù–∞—Å—Ç—É–ø–Ω–µ –≤–∏–º–∫–Ω–µ–Ω–Ω—è –æ—á—ñ–∫—É—î—Ç—å—Å—è –æ <b>${formatHM(e)}</b>.<br><br><i>* –í–∫–ª—é—á–µ–Ω–Ω—è/–≤–∏–º–∫–Ω–µ–Ω–Ω—è –º–æ–∂–µ –±—É—Ç–∏ –∑ –Ω–µ–≤–µ–ª–∏–∫–æ—é –ø–æ—Ö–∏–±–∫–æ—é.</i>`
                        : `–°–≤—ñ—Ç–ª–æ –±—É–¥–µ –≤–∏–º–∫–Ω–µ–Ω–µ –æ <b>${formatHM(s)}</b> —ñ –ø–æ–≤–µ—Ä–Ω–µ—Ç—å—Å—è –æ <b>${formatHM(e)}</b>.<br>–ü–ª–∞–Ω–æ–≤–µ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è.<br><br><i>* –í–∫–ª—é—á–µ–Ω–Ω—è/–≤–∏–º–∫–Ω–µ–Ω–Ω—è –º–æ–∂–µ –≤—ñ–¥–±—É–≤–∞—Ç–∏—Å—è –∑ –Ω–µ–≤–µ–ª–∏–∫–æ—é –ø–æ—Ö–∏–±–∫–æ—é —É —á–∞—Å—ñ.</i>`
                    }
                </div>`;
            c.addEventListener("click", (ev) => {
                ev.stopPropagation();
                if (activeListCard === c) {
                    c.classList.remove("expanded");
                    activeListCard = null;
                    return;
                }
                if (activeListCard) { activeListCard.classList.remove("expanded"); }
                c.classList.add("expanded");
                activeListCard = c;
            });
            return c;
        }

        function fmtTimer(s) {
            const h = Math.floor(s / 3600); const m = Math.floor((s % 3600) / 60); const sec = s % 60;
            return `${h}:${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
        }
        function formatHM(dt) {
            let h = Math.floor(dt) % 24; let m = Math.round((dt - Math.floor(dt)) * 60);
            if (m === 60) { h = (h + 1) % 24; m = 0; }
            return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
        }
        function fmtDur(dh) {
            let h = Math.floor(dh); let m = Math.round((dh - h) * 60);
            if (m > 0) return `${h} –≥–æ–¥ ${m} —Ö–≤`;
            return `${h} –≥–æ–¥–∏–Ω`;
        }

        // --- FAB LOGIC ---
        function toggleFab() {
            const container = document.getElementById('fabContainer');
            const overlay = document.getElementById('fabOverlay');
            container.classList.toggle('active');
            overlay.classList.toggle('active');
            try { tg.HapticFeedback.selectionChanged(); } catch (e) {}
        }
        document.addEventListener('click', function(event) {
            const container = document.getElementById('fabContainer');
            const isClickInside = container.contains(event.target);
            const overlay = document.getElementById('fabOverlay');
            if (!isClickInside && container.classList.contains('active') && event.target.id !== 'fabOverlay') {
                container.classList.remove('active');
                overlay.classList.remove('active');
            }
        });

        // --- THEME ---
        function toggleTheme() {
            const body = document.body;
            const icon = document.getElementById('fabThemeIcon');
            const isLight = body.getAttribute('data-theme') === 'light';
            if (isLight) {
                body.removeAttribute('data-theme');
                localStorage.setItem('theme', 'dark');
                if(icon) icon.innerText = 'üåô';
            } else {
                body.setAttribute('data-theme', 'light');
                localStorage.setItem('theme', 'light');
                if(icon) icon.innerText = '‚òÄÔ∏è';
            }
            try { tg.HapticFeedback.impactOccurred('medium'); } catch (e) {}
        }
        function loadTheme() {
            const saved = localStorage.getItem('theme');
            const icon = document.getElementById('fabThemeIcon');
            if (saved === 'light') {
                document.body.setAttribute('data-theme', 'light');
                if(icon) icon.innerText = '‚òÄÔ∏è';
            } else {
                if(icon) icon.innerText = 'üåô';
            }
        }

        function showInfo(type) {
            const overlay = document.getElementById('infoModal');
            const title = document.getElementById('infoTitle');
            const text = document.getElementById('infoText');

            if (type === 'about') {
                title.innerText = "ü§ñ –ü—Ä–æ –±–æ—Ç–∞";
                text.innerHTML = `
                    –ó—Ä—É—á–Ω–∏–π –±–æ—Ç –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É –≥—Ä–∞—Ñ—ñ–∫—ñ–≤ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å —É –º. –ë—Ä–æ–≤–∞—Ä–∏.<br><br>
                    <b>–†–æ–∑—Ä–æ–±–Ω–∏–∫:</b> <a href="https://t.me/svitlopromo" target="_blank">@svitlopromo</a><br><br>
                    –ú–∏ –±–µ—Ä–µ–º–æ –æ—Ñ—ñ—Ü—ñ–π–Ω—ñ –¥–∞–Ω—ñ —Ç–∞ —Ä–æ–±–∏–º–æ —ó—Ö –∑—Ä–æ–∑—É–º—ñ–ª–∏–º–∏.
                `;
            } else if (type === 'queue') {
                title.innerText = "‚ùì –Ø–∫ –¥—ñ–∑–Ω–∞—Ç–∏—Å—è —á–µ—Ä–≥—É";
                text.innerHTML = `
                    –í–∞—à–∞ —á–µ—Ä–≥–∞ –∑–∞–ª–µ–∂–∏—Ç—å –≤—ñ–¥ –∞–¥—Ä–µ—Å–∏ –ø—Ä–æ–∂–∏–≤–∞–Ω–Ω—è.<br><br>
                    1. –ó–∞–π–¥—ñ—Ç—å –Ω–∞ —Å–∞–π—Ç <a href="https://www.dtek-krem.com.ua/ua/shutdowns" target="_blank">–î–¢–ï–ö</a>.<br>
                    2. –í–≤–µ–¥—ñ—Ç—å —Å–≤–æ—é –≤—É–ª–∏—Ü—é.<br>
                    3. –ü–æ–¥–∏–≤—ñ—Ç—å—Å—è –Ω–æ–º–µ—Ä –≥—Ä—É–ø–∏.<br><br>
                    –ü–æ—Ç—ñ–º –æ–±–µ—Ä—ñ—Ç—å —Ü—é —á–µ—Ä–≥—É —É —Å–ø–∏—Å–∫—É –∑–≤–µ—Ä—Ö—É.
                `;

             } else if (type === 'faq') {
                title.innerText = "üí¨ –ü–∏—Ç–∞–Ω–Ω—è-–≤—ñ–¥–ø–æ–≤—ñ–¥—ñ";
                text.innerHTML = `
                    <b>1. –ß–æ–º—É –≥—Ä–∞—Ñ—ñ–∫ —É –±–æ—Ç—ñ –Ω–µ —Å–ø—ñ–≤–ø–∞–¥–∞—î –∑ —Ä–µ–∞–ª—å–Ω—ñ—Å—Ç—é?</b><br>
                    –ß–µ—Ä–µ–∑ –∞–≤–∞—Ä—ñ—ó –∞–±–æ –µ–∫—Å—Ç—Ä–µ–Ω—ñ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è. –ì—Ä–∞—Ñ—ñ–∫ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î –ª–∏—à–µ —Å—Ç–∞–±—ñ–ª—ñ–∑–∞—Ü—ñ–π–Ω—ñ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è.<br><br>

                    <b>2. –ó–≤—ñ–¥–∫–∏ –≤–∏ –±–µ—Ä–µ—Ç–µ –≥—Ä–∞—Ñ—ñ–∫–∏?</b><br>
                    –ó –æ—Ñ—ñ—Ü—ñ–π–Ω–æ–≥–æ —Å–∞–π—Ç—É –î–¢–ï–ö. –î–∞–Ω—ñ –æ–±—Ä–æ–±–ª—è—é—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ.<br><br>

                    <b>3. –ú–æ—è –∞–¥—Ä–µ—Å–∞ –±–µ–∑ —Å–≤—ñ—Ç–ª–∞, –∞ –ø–æ –≥—Ä–∞—Ñ—ñ–∫—É –º–∞—î –±—É—Ç–∏ —Å–≤—ñ—Ç–ª–æ!</b><br>
                    –¶–µ –ª–æ–∫–∞–ª—å–Ω–∞ –∞–≤–∞—Ä—ñ—è –∞–±–æ –µ–∫—Å—Ç—Ä–µ–Ω–µ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è ‚Äî –≤–æ–Ω–∏ –Ω–µ –≤—Ö–æ–¥—è—Ç—å —É –≥—Ä–∞—Ñ—ñ–∫.<br><br>

                    <b>4. –ß–æ–º—É –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –≥—Ä–∞—Ñ—ñ–∫—ñ–≤ –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –Ω–µ –æ–¥—Ä–∞–∑—É?</b><br>
                    –î–¢–ï–ö –Ω–µ –∑–∞–≤–∂–¥–∏ –æ–Ω–æ–≤–ª—é—î –¥–∞–Ω—ñ –≤—á–∞—Å–Ω–æ. –ú–∏ –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —ó—Ö —Ä–µ–≥—É–ª—è—Ä–Ω–æ.<br><br>
                `;

            } else if (type === 'emergency') {
                title.innerText = "üö® –ê–≤–∞—Ä—ñ–π–Ω—ñ —Å–ª—É–∂–±–∏ –ë—Ä–æ–≤–∞—Ä—ñ–≤";
                text.innerHTML = `
                    ‚ö° <b>–î–¢–ï–ö –ö–∏—ó–≤—Å—å–∫—ñ —Ä–µ–≥—ñ–æ–Ω–∞–ª—å–Ω—ñ –µ–ª–µ–∫—Ç—Ä–æ–º–µ—Ä–µ–∂—ñ</b><br>
                    –ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ: <a href="tel:0800400740">0 800 400 740</a><br><br>

                    üèõ <b>–ö–æ–Ω—Ç–∞–∫—Ç-—Ü–µ–Ω—Ç—Ä –ë—Ä–æ–≤–∞—Ä—Å—å–∫–æ—ó –º—ñ—Å—å–∫–æ—ó —Ä–∞–¥–∏</b><br>
                    <a href="tel:+380459461111">+38 045 946 1111</a><br><br>

                    üíß <b>–ë—Ä–æ–≤–∞—Ä–∏—Ç–µ–ø–ª–æ–≤–æ–¥–æ–µ–Ω–µ—Ä–≥—ñ—è</b><br>
                    <a href="tel:+380459441101">+38 045 944 1101</a><br><br>

                    üî• <b>–î–°–ù–° (–ü–æ–∂–µ–∂–Ω–∞ —Å–ª—É–∂–±–∞):</b> <a href="tel:101">101</a><br>
                    üöë <b>–®–≤–∏–¥–∫–∞ –¥–æ–ø–æ–º–æ–≥–∞:</b> <a href="tel:103">103</a><br>
                    üëÆ <b>–ü–æ–ª—ñ—Ü—ñ—è:</b> <a href="tel:102">102</a><br><br>

                    ‚ùó –£ —Ä–∞–∑—ñ –Ω–µ–±–µ–∑–ø–µ–∫–∏ —Ç–µ–ª–µ—Ñ–æ–Ω—É–π—Ç–µ 101 –∞–±–æ 103.
                `;

            } else if (type === 'support') {
                title.innerText = "üíö –ü—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏";
                text.innerHTML = `
                    –î—è–∫—É—î–º–æ, —â–æ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç–µ –Ω–∞—à –ø—Ä–æ—î–∫—Ç!<br><br>
                    –í–∞—à—ñ –¥–æ–Ω–∞—Ç–∏ –¥–æ–ø–æ–º–∞–≥–∞—é—Ç—å –Ω–∞–º:<br>
                    ‚Ä¢ –ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞—Ç–∏ —Ä–æ–±–æ—Ç—É –±–æ—Ç–∞ üñ•Ô∏è<br>
                    ‚Ä¢ –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏ –≥—Ä–∞—Ñ—ñ–∫–∏ ‚ö°Ô∏è<br>
                    ‚Ä¢ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –Ω–æ–≤—ñ —Ñ—É–Ω–∫—Ü—ñ—ó üîß<br><br>
                    üîó <a href="https://send.monobank.ua/jar/6qoHuhpGgD" target="_blank">Monobank (–ë–∞–Ω–∫–∞)</a><br><br>
                    üí≥ –ê–±–æ –∫–∞—Ä—Ç–∫–æ—é:<br><b>4874 1000 2226 7571</b>
                `;
            } else if (type === 'collab') {
                title.innerText = "ü§ù –°–ø—ñ–≤–ø—Ä–∞—Ü—è";
                text.innerHTML = `
                    –ó –ø–∏—Ç–∞–Ω—å —Å–ø—ñ–≤–ø—Ä–∞—Ü—ñ —Ç–∞ —Ä–µ–∫–ª–∞–º–∏ –∑–≤–µ—Ä—Ç–∞–π—Ç–µ—Å—å –¥–æ —Ä–æ–∑—Ä–æ–±–Ω–∏–∫–∞:<br><br>
                    üëâ <a href="https://t.me/svitlopromo" target="_blank">@svitlopromo</a>
                `;
            }

            overlay.classList.add('show');
            const fab = document.getElementById('fabContainer');
            const fabOverlay = document.getElementById('fabOverlay');
            if(fab) fab.classList.remove('active');
            if(fabOverlay) fabOverlay.classList.remove('active');
        }

        async function fetchDonation() {
            try {
                const url = `${CSV_PROXY_URL}?jar=true&t=${Date.now()}`;
                const r = await fetch(url);
                const data = await r.json();

                if (data.amount !== undefined) {
                    updateDonateUI(data.amount, data.goal);
                }
            } catch (e) {
                console.error("Donation error:", e);
                document.getElementById('donateAmount').innerText = "–ú–æ–Ω–æ–±–∞–Ω–∫–∞";
            }
        }

        // === ANIMATED SWIPE CONTROL ===

        let touchStartX = 0;
        let touchEndX = 0;
        let swipeLocked = false; // —â–æ–± –Ω–µ –¥—É–±–ª—ñ–∫—É–≤–∞—Ç–∏ —Å–≤–∞–π–ø–∏

        document.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
        }, false);

        document.addEventListener('touchend', (e) => {
            touchEndX = e.changedTouches[0].screenX;
            handleAnimatedSwipe();
        }, false);

        function handleAnimatedSwipe() {
            if (swipeLocked) return;

            const dx = touchEndX - touchStartX;
            if (Math.abs(dx) < 60) return;

            const box = document.getElementById('app-content');

            if (dx < 0 && currentTab !== 2) {
                // –°–≤–∞–π–ø –≤–ª—ñ–≤–æ ‚Üí –ù–ê –ó–ê–í–¢–†–ê
                swipeLocked = true;
                box.classList.add('swipe-left');

                try { tg.HapticFeedback.selectionChanged(); } catch(e){}

                setTimeout(() => {
                    switchTab(2);
                    box.classList.remove('swipe-left');
                    box.classList.add('swipe-right');

                    setTimeout(() => {
                        box.classList.remove('swipe-right');
                        box.classList.add('swipe-reset');
                        swipeLocked = false;
                    }, 10);
                }, 250);

            } else if (dx > 0 && currentTab !== 1) {
                // –°–≤–∞–π–ø –≤–ø—Ä–∞–≤–æ ‚Üí –ù–ê –°–¨–û–ì–û–î–ù–Ü
                swipeLocked = true;
                box.classList.add('swipe-right');

                try { tg.HapticFeedback.selectionChanged(); } catch(e){}

                setTimeout(() => {
                    switchTab(1);
                    box.classList.remove('swipe-right');
                    box.classList.add('swipe-left');

                    setTimeout(() => {
                        box.classList.remove('swipe-left');
                        box.classList.add('swipe-reset');
                        swipeLocked = false;
                    }, 10);
                }, 250);
            }
        }

        function scrollToActiveQueue() {
            const box = document.getElementById("queueList");
            const active = box.querySelector(".q-item.active");
            if (!active) return;

            const offset = active.offsetTop - (box.clientHeight / 2) + (active.clientHeight / 2);

            box.scrollTo({
                top: offset,
                behavior: "smooth"
            });

            active.classList.add("pulse");
            setTimeout(() => active.classList.remove("pulse"), 1200);
        }

        function shareSchedule() {
            try { tg.HapticFeedback.impactOccurred('light'); } catch(e) {}

            const text =
        `https://t.me/SvitloBroBot
        ‚ö°Ô∏è –Ø –∫–æ—Ä–∏—Å—Ç—É—é—Å—å –±–æ—Ç–æ–º –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –≥—Ä–∞—Ñ—ñ–∫—ñ–≤ –≤—ñ–¥–∫–ª—é—á–µ–Ω—å —Å–≤—ñ—Ç–ª–∞ —É –ë—Ä–æ–≤–∞—Ä–∞—Ö. –ü—Ä–∏—î–¥–Ω—É–π—Å—è!
        –ú–æ—è —á–µ—Ä–≥–∞: ${currentQueue}`;

            // –ö–æ–ø—ñ—é—î–º–æ —Ç–µ–∫—Å—Ç —É –±—É—Ñ–µ—Ä
            navigator.clipboard.writeText(text).then(() => {
                tg.showPopup({
                    title: "–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!",
                    message: "–¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ. –í—Å—Ç–∞–≤—Ç–µ –π–æ–≥–æ —É —á–∞—Ç.",
                    buttons: [
                        {id: "open_tg", type: "default", text: "–í—ñ–¥–∫—Ä–∏—Ç–∏ Telegram"},
                        {type: "cancel"}
                    ]
                }, (btn) => {
                    if (btn === "open_tg") {
                        tg.openTelegramLink("https://t.me/share/url?url=" + encodeURIComponent(text));
                    }
                });
            });
        }

        function updateDonateUI(amount, goal) {
            const target = goal > 0 ? goal : (amount > 0 ? amount * 1.2 : 5000);
            let pct = (amount / target) * 100;
            if (pct > 100) pct = 100;

            const progress = document.getElementById('donateProgress');
            if (progress) progress.style.width = `${pct}%`;

            const fmtAmount = amount.toLocaleString('uk-UA', {maximumFractionDigits: 0});
            const fmtGoal   = target.toLocaleString('uk-UA', {maximumFractionDigits: 0});

            const amountEl = document.getElementById('donateAmount');
            if (amountEl) {
                if (goal > 0) {
                    amountEl.innerText = `${fmtAmount} / ${fmtGoal} ‚Ç¥`;
                } else {
                    amountEl.innerText = `${fmtAmount} ‚Ç¥`;
                }
            }
        }


        function closeInfo() {
            document.getElementById('infoModal').classList.remove('show');
        }

        // Auto-update day
        let currentDayNum = new Date().getDate();
        setInterval(() => {
            const now = new Date();
            if (now.getDate() !== currentDayNum) { currentDayNum = now.getDate(); init(); }
        }, 1000);

        // üî• –ó–ê–ü–£–°–ö
    init();
    fetchDonation();
</script>

</body>
</html>
