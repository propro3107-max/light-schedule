<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–ì—Ä–∞—Ñ—ñ–∫ –°–≤—ñ—Ç–ª–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #12121a;
            --card-bg: #1e1e2a;
            --accent-green: #2ecc71;
            --accent-red: #e74c3c;
            --accent-gray: #3a3a45;
            --text-muted: #8e8e93;
            --radius: 16px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-color); color: white;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; padding-bottom: 100px;
            -webkit-font-smoothing: antialiased;
        }

        .header {
            width: 100%; padding: 20px 0 10px 0;
            text-align: center; background: var(--bg-color);
            position: sticky; top: 0; z-index: 50;
        }
        .queue-select-btn {
            display: inline-flex; align-items: center; gap: 8px;
            font-size: 18px; font-weight: 700; color: white;
            background: rgba(255,255,255,0.1); padding: 8px 16px; border-radius: 20px;
            cursor: pointer; transition: 0.2s; border: 1px solid rgba(255,255,255,0.05);
        }
        .queue-select-btn:active { background: rgba(255,255,255,0.2); }
        .arrow-icon { font-size: 12px; opacity: 0.7; transition: 0.3s; }
        .queue-select-btn.open .arrow-icon { transform: rotate(180deg); }

        #app-content {
            width: 100%; max-width: 500px; padding: 0 24px;
            display: flex; flex-direction: column; gap: 24px;
        }

        .battery-container { display: flex; flex-direction: column; align-items: center; margin-top: 10px; }
        .battery-wrapper { display: flex; align-items: center; position: relative; }
        .battery-shell {
            width: 160px; height: 48px;
            border: 3px solid rgba(255,255,255,0.2); border-radius: 14px;
            padding: 4px; position: relative;
        }
        .battery-tip { width: 6px; height: 18px; background: rgba(255,255,255,0.2); border-radius: 0 4px 4px 0; margin-left: 4px; }
        .battery-fill {
            height: 100%; width: 100%; border-radius: 9px; transition: width 0.5s;
        }
        .fill-green { background: var(--accent-green); box-shadow: 0 0 15px rgba(46, 204, 113, 0.4); }
        .fill-red { background: var(--accent-red); box-shadow: 0 0 15px rgba(231, 76, 60, 0.4); }
        .fill-gray { background: var(--accent-gray); width: 100% !important; box-shadow: none; }

        .battery-text {
            position: absolute; top: 50%; left: 50%; transform: translate(-52%, -50%);
            font-size: 22px; font-weight: 700; text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            font-variant-numeric: tabular-nums; width: 100%; text-align: center;
        }
        .battery-status { margin-top: 8px; font-size: 13px; color: var(--text-muted); font-weight: 500; }

        .date-header { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .date-line { flex: 1; height: 1px; background: #2c2c35; }
        .date-text { font-size: 14px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }

        .timeline-section { width: 100%; }
        .timeline-box { position: relative; padding: 0 10px; }

        .timeline-track {
            position: relative;
            width: 100%;
            height: 44px;
            display: flex;
            align-items: stretch;
            gap: 10px;
            background: transparent;
            padding: 0;
            box-shadow: none;
            overflow: visible;
        }

        .segment {
            position: relative;
            flex-grow: 1;
            flex-basis: 0;
            height: 100%;
            min-width: 32px;
            border-radius: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 14px rgba(0,0,0,0.45);
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.15s ease, outline 0.15s ease;
            z-index: 20;
        }

        .segment-selected {
            transform: translateY(-2px);
            outline: 2px solid #ffffff;
            box-shadow: 0 0 16px rgba(255,255,255,0.4);
        }

        .on  { background: var(--accent-green); }
        .off { background: var(--accent-red); }

        .segment-icon {
            font-size: 18px; color: white; z-index: 2;
            filter: drop-shadow(0 1px 1px rgba(0,0,0,0.25));
            opacity: 0.95;
        }

        .cursor-line {
            position: absolute;
            top: -6px;
            bottom: -6px;
            width: 2px;
            background: #ffffff;
            z-index: 30;
            border-radius: 999px;
            box-shadow: 0 0 12px rgba(255,255,255,0.9);
            pointer-events: none;
        }

        .time-labels { position: relative; width: 100%; height: 24px; margin-top: 8px; }

        .t-label {
            position: absolute; top: 0;
            font-size: 11px; font-weight: 600; color: var(--text-muted);
            transform: translateX(-50%); white-space: nowrap; letter-spacing: 0.3px;
        }
        .t-label.start { transform: translateX(0%); }
        .t-label.end { transform: translateX(-100%); }
        .t-label.mid { transform: translateX(0%); }

        .t-tick {
            position: absolute; top: -6px; left: 50%;
            width: 1px; height: 4px; background: #444;
        }

        .detail-card-container { margin-top: 12px; }

        .detail-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 16px 18px 14px;
            border: 2px solid transparent;
            box-shadow: 0 10px 25px rgba(0,0,0,0.45);
            position: relative;
            overflow: hidden;
        }

        .top-bar {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px;
            margin-top: 10px;
            gap: 10px;
        }

        .top-bar .updated,
        .top-bar .users {
            font-size: 13px;
            color: var(--text-muted);
        }

        .queue-selector {
            background: rgba(255,255,255,0.08);
            padding: 6px 12px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 14px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .detail-card.on {
            border-color: var(--accent-green);
            box-shadow: 0 0 18px rgba(46, 204, 113, 0.35);
        }

        .detail-card.off {
            border-color: var(--accent-red);
            box-shadow: 0 0 18px rgba(231, 76, 60, 0.35);
        }

        .detail-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .detail-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .detail-icon {
            font-size: 22px;
            width: 26px;
            text-align: center;
        }

        .detail-main {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .detail-status {
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-status-on  { color: var(--accent-green); }
        .detail-status-off { color: var(--accent-red); }

        .detail-time { font-size: 16px; font-weight: 700; }

        .detail-duration {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-muted);
            white-space: nowrap;
        }

        .detail-divider {
            margin: 10px 0 8px 0;
            height: 1px;
            background: rgba(255,255,255,0.06);
        }

        .detail-body {
            font-size: 14px;
            line-height: 1.45;
            color: #d5d5d7;
        }

        .detail-body p { margin: 0 0 4px 0; }

        .detail-note {
            margin-top: 6px;
            font-size: 12px;
            font-style: italic;
            color: var(--text-muted);
        }

        .card-list { display: flex; flex-direction: column; gap: 12px; }

        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 16px;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .card::before {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0;
            width: 4px;
        }
        .card.c-on::before { background: var(--accent-green); }
        .card.c-off::before { background: var(--accent-red); }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .card.active-now {
            background: rgba(255,255,255,0.08); border-color: white;
            box-shadow: 0 0 15px rgba(255,255,255,0.15); transform: scale(1.02); z-index: 10;
        }
        .card.active-now.c-on { border-color: var(--accent-green); box-shadow: 0 0 15px rgba(46, 204, 113, 0.3); }
        .card.active-now.c-off { border-color: var(--accent-red); box-shadow: 0 0 15px rgba(231, 76, 60, 0.3); }
        .card.active-now::before { display: none; }

        .card-info { display: flex; align-items: center; gap: 14px; }
        .c-icon { font-size: 20px; width: 24px; text-align: center; }
        .c-times { display: flex; flex-direction: column; gap: 2px; }

        .status-label { font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
        .c-on .status-label { color: var(--accent-green); }
        .c-off .status-label { color: var(--accent-red); }

        .c-time { font-size: 16px; font-weight: 700; color: white; }
        .c-dur { font-size: 14px; font-weight: 500; color: var(--text-muted); }

        .card-details {
            padding: 0 2px 0 2px;
            font-size: 13px;
            color: #aaa;
            line-height: 1.5;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: all 0.25s ease;
        }

        .card.expanded .card-details {
            max-height: 200px;
            opacity: 1;
            margin-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.08);
            padding-top: 10px;
        }

        .total-block {
            text-align: center; padding: 20px;
            color: var(--text-muted); font-size: 14px; font-weight: 500;
        }
        .total-block b { color: white; }

        .no-data-msg {
            text-align: center; color: #666; padding: 30px 20px;
            background: rgba(255,255,255,0.03); border-radius: 16px;
            font-size: 15px; margin-top: 10px;
        }

        .donate-wrapper { display: flex; justify-content: center; width: 100%; margin-top: 10px; margin-bottom: 20px; }
        .donate-btn {
            background: linear-gradient(90deg, #FFC107, #FF9800); color: #000;
            text-decoration: none; font-weight: 800; font-size: 16px;
            padding: 14px 35px; border-radius: 50px;
            box-shadow: 0 5px 20px rgba(255, 152, 0, 0.3);
            transition: transform 0.2s; display: flex; align-items: center; gap: 10px;
        }
        .donate-btn:active { transform: scale(0.96); }

        .tab-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(24, 24, 32, 0.95); backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255,255,255,0.05);
            display: flex; padding: 10px 20px 30px 20px;
            justify-content: space-between; gap: 10px; z-index: 80;
        }
        .tab-item {
            flex: 1; background: transparent; border: none; padding: 10px;
            border-radius: 12px; color: var(--text-muted);
            font-size: 14px; font-weight: 600; cursor: pointer; transition: 0.2s; text-align: center;
        }
        .tab-item.active { background: #343442; color: white; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 99;
            opacity: 0; visibility: hidden; transition: 0.3s; backdrop-filter: blur(5px);
        }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .queue-list {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: #1e1e2a; border-radius: 24px 24px 0 0;
            padding: 20px; max-height: 70vh; overflow-y: auto;
            transform: translateY(100%); transition: 0.3s;
        }
        .modal-overlay.show .queue-list { transform: translateY(0); }
        .q-item {
            padding: 16px; margin-bottom: 8px; background: rgba(255,255,255,0.05);
            border-radius: 12px; text-align: center; font-weight: 600; cursor: pointer;
        }
        .q-item.active { background: #3498db; color: white; }

        #loading { margin-top: 100px; color: var(--text-muted); text-align: center; font-size: 14px; }
        .hidden { display: none !important; }
        .offline-badge {
            position: fixed; top: 10px; right: 10px; background: rgba(255, 69, 58, 0.9);
            color: white; padding: 4px 10px; border-radius: 8px; font-size: 11px; z-index: 100;
            font-weight: bold; backdrop-filter: blur(4px);
        }

        .loader {
            margin-top: 120px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .loader .dot {
            width: 12px;
            height: 12px;
            background: #ffffff;
            border-radius: 50%;
            animation: pulseDot 0.85s infinite ease-in-out;
            opacity: 0.6;
        }
        @keyframes pulseDot {
            0%   { transform: scale(0.55); opacity: 0.35; }
            50%  { transform: scale(1);    opacity: 1; }
            100% { transform: scale(0.55); opacity: 0.35; }
        }
    </style>
</head>
<body>

    <div class="top-bar">
        <span class="updated" id="topUpdated">–û–Ω–æ–≤–ª–µ–Ω–æ‚Ä¶</span>
        <span style="flex: 1;"></span>
        <span class="users" id="topUsers">üë• ‚Ä¶</span>
    </div>



    <div class="header">
        <div class="queue-select-btn" onclick="toggleModal()">
            <span id="queueTitle">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span>
            <span class="arrow-icon">‚ñº</span>
        </div>
    </div>

    <div id="loader" class="loader">
        <div class="dot"></div>
    </div>

    <div id="loading">–û—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö...</div>

    <div id="app-content" class="hidden">

        <div id="batterySection" class="battery-container">
            <div class="battery-wrapper">
                <div class="battery-shell">
                    <div id="batteryFill" class="battery-fill fill-green"></div>
                    <div class="battery-text" id="batteryTimer">--:--</div>
                </div>
                <div class="battery-tip"></div>
            </div>
            <div class="battery-status" id="batteryLabel">—Å—Ç–∞—Ç—É—Å</div>
        </div>

        <div class="date-header">
            <div class="date-line"></div>
            <div class="date-text" id="dateDisplay">...</div>
            <div class="date-line"></div>
        </div>

        <div class="timeline-section" id="timelineSection">
            <div class="timeline-box">
                <div class="timeline-track" id="timelineTrack"></div>
                <div class="time-labels" id="timeLabelsBox"></div>
            </div>
            <div id="detailCardContainer" class="detail-card-container hidden"></div>
        </div>

        <div id="noDataMessage" class="no-data-msg hidden">
            üí§ –ì—Ä–∞—Ñ—ñ–∫ –Ω–∞ —Ü–µ–π –¥–µ–Ω—å —â–µ –Ω–µ —Å—Ñ–æ—Ä–º–æ–≤–∞–Ω–æ
        </div>

        <div class="card-list" id="infoBox"></div>
        <div class="total-block" id="totalBox"></div>

        <div class="donate-wrapper">
            <a href="https://send.monobank.ua/jar/6qoHuhpGgD" target="_blank" class="donate-btn">
                ‚ö° –ü—ñ–¥–∑–∞—Ä—è–¥–∏—Ç–∏ –±–æ—Ç–∞
            </a>
        </div>
    </div>

    <div class="tab-bar">
        <div class="tab-item active" id="tab1" onclick="switchTab(1)">–°—å–æ–≥–æ–¥–Ω—ñ</div>
        <div class="tab-item" id="tab2" onclick="switchTab(2)">–ó–∞–≤—Ç—Ä–∞</div>
    </div>

    <div class="modal-overlay" id="modal" onclick="toggleModal()">
        <div class="queue-list" id="queueList" onclick="event.stopPropagation()"></div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

            function getUrlParam(name) {
        const url = new URL(window.location.href);
        return url.searchParams.get(name);
    }


        // ==== –ß–ò–¢–ê–ù–ù–Ø –î–ê–ù–ò–• –ó startapp (payload –≤—ñ–¥ –±–æ—Ç–∞) ====
            (function applyStartAppData() {
                let param = null;

                // 1) –°–ø–µ—Ä—à—É —á–∏—Ç–∞—î–º–æ URL –ø–∞—Ä–∞–º–µ—Ç—Ä ?startapp=
                const fromUrl = getUrlParam("startapp");
                if (fromUrl) {
                    param = fromUrl;
                }

                // 2) –Ø–∫—â–æ –π–æ–≥–æ –Ω–µ–º–∞ ‚Äî –±–µ—Ä–µ–º–æ start_param –≤—ñ–¥ Telegram
                if (!param) {
                    param = tg.initDataUnsafe?.start_param;
                }

                if (!param) return; // –Ω—ñ—á–æ–≥–æ –Ω–µ–º–∞—î ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ

                try {
                    const json = JSON.parse(
                        atob(param.replace(/-/g, '+').replace(/_/g, '/'))
                    );

                    console.log("Start PARAM JSON:", json);

                    if (json.updated) {
                        document.getElementById("topUpdated").innerText =
                            "–û–Ω–æ–≤–ª–µ–Ω–æ: " + json.updated;
                    }

                    if (json.users) {
                        document.getElementById("topUsers").innerText =
                            "üë• " + json.users;
                    }

                    if (json.queue) {
                        currentQueue = json.queue;
                        localStorage.setItem('savedQueue', json.queue);
                    }

                } catch (err) {
                    console.error("–ü–æ–º–∏–ª–∫–∞ —á–∏—Ç–∞–Ω–Ω—è start_param:", err);
                }
            })();


        // üîó URL —Ç–≤–æ–≥–æ Cloudflare Worker
        const CSV_PROXY_URL = "https://shy-fog-bb74svitlo-proxy.propro3107.workers.dev";

        let allData = [];
        let currentQueue = "1.1";
        let currentTab = 1;
        let countdownInterval;
        let activeSegmentElement = null;
        let activeListCard = null;
        let cursor = null;

        function ensureCursor() {
            if (!cursor) {
                cursor = document.createElement('div');
                cursor.id = 'cursor';
                cursor.className = 'cursor-line';
            }
        }

        setInterval(() => init(true), 120000);

        async function getCSV(retries = 1) {
            const url = `${CSV_PROXY_URL}?t=${Date.now()}`;
            try {
                const r = await fetch(url, { cache: "no-cache" });
                if (!r.ok) throw new Error("Bad status " + r.status);
                return await r.text();
            } catch (e) {
                if (retries > 0) {
                    return getCSV(retries - 1);
                }
                throw e;
            }
        }

        async function init(isSilent = false) {
            try {
                if (!isSilent) {
                    document.getElementById('loader').classList.remove('hidden');
                    document.getElementById('loading').classList.remove('hidden');
                    document.getElementById('loading').innerText = "–û–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...";
                }

                const csvText = await getCSV();
                allData = parseCSV(csvText);

                window.LAST_UPDATED = null;
                for (const row of allData) {
                    if (row.updated_at && row.updated_at.trim() !== "") {
                        window.LAST_UPDATED = row.updated_at.trim();
                        break;
                    }
                }

                updateTopUpdated();


                if (!allData.length) throw new Error("Empty Data");

                localStorage.setItem('cachedData', JSON.stringify(allData));
                removeOfflineBadge();

                document.getElementById('loader').classList.add('hidden');
                document.getElementById('loading').classList.add('hidden');

                setupApp(isSilent);

            } catch (e) {
                console.error("Online fetch error:", e);

                const cached = localStorage.getItem('cachedData');

                if (cached) {
                    allData = JSON.parse(cached);
                    showOfflineBadge();

                window.LAST_UPDATED = null;
                for (const row of allData) {
                    if (row.updated_at && row.updated_at.trim() !== "") {
                        window.LAST_UPDATED = row.updated_at.trim();
                        break;
                    }
                }

                // —Ç—É—Ç —Ç–µ–∂ –¥–æ–¥–∞–π
                updateTopUpdated();


                    document.getElementById('loader').classList.add('hidden');
                    document.getElementById('loading').classList.add('hidden');

                    setupApp(isSilent);
                } else {
                    if (!isSilent) {
                        document.getElementById('loader').classList.add('hidden');
                        document.getElementById('loading').classList.remove('hidden');
                        document.getElementById('loading').innerText = "–ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è.";
                    }
                }
            }
        }

        function setupApp(isSilent) {
            const p = new URLSearchParams(window.location.search);
            let q = p.get('q');

            if (q) q = q.trim();
            if (!q) q = localStorage.getItem('savedQueue');
            if (q) q = q.trim();

            if (q && allData.find(r => (r.group_id || "").trim() === q)) {
                currentQueue = q;
            } else if (allData.length) {
                currentQueue = (allData[0].group_id || "").trim();
            }

            localStorage.setItem('savedQueue', currentQueue);

            if (!isSilent) {
                buildMenu();
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
            }

            render(currentTab);
        }

        function showOfflineBadge() {
            if (!document.getElementById('offBadge')) {
                const b = document.createElement('div');
                b.id = 'offBadge'; b.className = 'offline-badge';
                b.innerText = 'Offline';
                document.body.appendChild(b);
            }
        }
        function removeOfflineBadge() {
            const b = document.getElementById('offBadge');
            if (b) b.remove();
        }

        function parseCSV(text) {
            const rows = [];
            let currentRow = [];
            let currentVal = '';
            let insideQuotes = false;
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const nextChar = text[i + 1];
                if (char === '"') {
                    if (insideQuotes && nextChar === '"') { i++; currentVal += '"'; }
                    else { insideQuotes = !insideQuotes; }
                } else if (char === ',' && !insideQuotes) {
                    currentRow.push(currentVal); currentVal = '';
                } else if ((char === '\r' || char === '\n') && !insideQuotes) {
                    if (char === '\r' && nextChar === '\n') i++;
                    if (currentVal || currentRow.length) currentRow.push(currentVal);
                    if (currentRow.length) rows.push(currentRow);
                    currentRow = []; currentVal = '';
                } else { currentVal += char; }
            }
            if (currentVal || currentRow.length) currentRow.push(currentVal);
            if (currentRow.length) rows.push(currentRow);
            const headers = rows[0].map(h => h.trim());
            return rows.slice(1).map(row => {
                let obj = {};
                headers.forEach((h, i) => {
                    let val = row[i] ?? "";
                    if (val && val.startsWith('"') && val.endsWith('"')) {
                        val = val.slice(1, -1);
                    }
                    obj[h] = val.trim();
                });
                return obj;
            });
        }

        function getSchedule(fullText, targetDate) {
            if (!fullText) return null;
            const daysMap = ["–ù–µ–¥—ñ–ª—è", "–ü–æ–Ω–µ–¥—ñ–ª–æ–∫", "–í—ñ–≤—Ç–æ—Ä–æ–∫", "–°–µ—Ä–µ–¥–∞", "–ß–µ—Ç–≤–µ—Ä", "–ü º—è—Ç–Ω–∏—Ü—è", "–°—É–±–æ—Ç–∞"];
            const dayName = daysMap[targetDate.getDay()];
            const lines = fullText.replace(/\r\n/g, '\n').split('\n');
            let dayLine = lines.find(line => line.trim().startsWith(dayName));
            if (!dayLine || dayLine.includes(":-") || dayLine.includes(": -") || dayLine.trim().endsWith("-")) return null;
            let timesPart = dayLine.includes(':') ? dayLine.substring(dayLine.indexOf(':') + 1).trim() : "";
            if (!timesPart || timesPart === "-") return null;
            timesPart = timesPart.replace(/\+/g, "");
            const ranges = timesPart.split(',');
            let arr = []; let lastTime = 0;
            ranges.forEach(r => {
                const parts = r.split('-').map(s => s.trim());
                if (parts.length < 2) return;
                const startH = timeToH(parts[0]); const endH = timeToH(parts[1]);
                if (isNaN(startH) || isNaN(endH)) return;
                if (startH > lastTime) arr.push(`${parseFloat((startH - lastTime).toFixed(2))}on`);
                let dur = endH - startH;
                if (endH < startH) dur = 24 - startH;
                if (dur > 0) arr.push(`${parseFloat(dur.toFixed(2))}off`);
                lastTime = (endH >= startH) ? endH : 24;
            });
            if (lastTime < 24) arr.push(`${parseFloat((24 - lastTime).toFixed(2))}on`);
            if (arr.length === 0) return "24on";
            return arr.join(',');
        }

        function timeToH(t) { const [h, m] = t.split(':').map(Number); return h + (m / 60); }

        function toggleModal() {
            document.getElementById('modal').classList.toggle('show');
            document.querySelector('.queue-select-btn').classList.toggle('open');
        }

        function selectQueue(q) {
            currentQueue = q;
            localStorage.setItem('savedQueue', q);
            try { tg.HapticFeedback.selectionChanged(); } catch (e) { }
            toggleModal();
            buildMenu();
            render(currentTab);
        }

        function buildMenu() {
            const list = document.getElementById('queueList');
            list.innerHTML = '<div style="text-align:center;margin-bottom:15px;color:#666;font-size:12px">–û–ë–ï–†–Ü–¢–¨ –ß–ï–†–ì–£</div>';

            const queues = [...new Set(allData.map(i => i.group_id))].sort();
            queues.forEach(q => {
                if (!q) return;
                let d = document.createElement('div');
                d.className = `q-item ${q == currentQueue ? 'active' : ''}`;
                d.innerText = `–ß–µ—Ä–≥–∞ ${q}`;
                d.onclick = () => selectQueue(q);
                list.appendChild(d);
            });

            document.getElementById('queueTitle').innerText = `–ß–ï–†–ì–ê ${currentQueue}`;

            const upd = window.LAST_UPDATED;
        }

        function formatUpdateTime(raw) {
            if (!raw) return "";

            const months = [
                "—Å—ñ—á–Ω—è","–ª—é—Ç–æ–≥–æ","–±–µ—Ä–µ–∑–Ω—è","–∫–≤—ñ—Ç–Ω—è","—Ç—Ä–∞–≤–Ω—è","—á–µ—Ä–≤–Ω—è",
                "–ª–∏–ø–Ω—è","—Å–µ—Ä–ø–Ω—è","–≤–µ—Ä–µ—Å–Ω—è","–∂–æ–≤—Ç–Ω—è","–ª–∏—Å—Ç–æ–ø–∞–¥–∞","–≥—Ä—É–¥–Ω—è"
            ];

            const [datePart, timePart] = raw.split(" ");
            const [Y, M, D] = datePart.split("-").map(Number);
            const [h, m] = timePart.split(":").map(Number);

            const dt = new Date(Y, M - 1, D, h, m);
            const now = new Date();

            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            const dayOnly = new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());

            if (dayOnly.getTime() === today.getTime()) {
                return `–û–Ω–æ–≤–ª–µ–Ω–æ: —Å—å–æ–≥–æ–¥–Ω—ñ –æ ${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
            }

            if (dayOnly.getTime() === yesterday.getTime()) {
                return `–û–Ω–æ–≤–ª–µ–Ω–æ: –≤—á–æ—Ä–∞ –æ ${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
            }

            return `–û–Ω–æ–≤–ª–µ–Ω–æ: ${D} ${months[M-1]} –æ ${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
        }

        function switchTab(idx) {
            currentTab = idx;
            try { tg.HapticFeedback.impactOccurred('light'); } catch (e) { }
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            document.getElementById('tab' + idx).classList.add('active');
            render(idx);
        }

        function render(dayIdx) {
            const row = allData.find(r => r.group_id == currentQueue);
            if (!row) return;

            ensureCursor();

            const targetDate = new Date();
            if (dayIdx === 2) targetDate.setDate(targetDate.getDate() + 1);

            const scheduleStr = getSchedule(row.schedule_text, targetDate);
            const d = String(targetDate.getDate()).padStart(2, '0');
            const m = String(targetDate.getMonth() + 1).padStart(2, '0');
            const daysMap = ["–ù–ï–î–Ü–õ–Ø", "–ü–û–ù–ï–î–Ü–õ–û–ö", "–í–Ü–í–¢–û–†–û–ö", "–°–ï–†–ï–î–ê", "–ß–ï–¢–í–ï–†", "–ü º–Ø–¢–ù–ò–¶–Ø", "–°–£–ë–û–¢–ê"];
            document.getElementById('dateDisplay').innerText = `${daysMap[targetDate.getDay()]} ${d}.${m}`;

            const track = document.getElementById('timelineTrack');
            const iBox = document.getElementById('infoBox');
            const lBox = document.getElementById('timeLabelsBox');
            const tlSec = document.getElementById('timelineSection');
            const totBox = document.getElementById('totalBox');
            const noData = document.getElementById('noDataMessage');
            const batSec = document.getElementById('batterySection');
            const detailBox = document.getElementById('detailCardContainer');

            track.innerHTML = '';
            lBox.innerHTML = '';
            iBox.innerHTML = '';
            detailBox.innerHTML = '';
            detailBox.classList.add('hidden');
            activeSegmentElement = null;
            activeListCard = null;
            clearInterval(countdownInterval);

            track.appendChild(cursor);

            if (scheduleStr === null) {
                tlSec.classList.add('hidden');
                totBox.classList.add('hidden');
                noData.classList.remove('hidden');
                if (dayIdx === 1) {
                    batSec.classList.remove('hidden');
                    document.getElementById('batteryTimer').innerText = "‚Äî";
                    document.getElementById('batteryLabel').innerText = "–ù–µ–≤—ñ–¥–æ–º–æ";
                    document.getElementById('batteryFill').className = 'battery-fill fill-gray';
                    document.getElementById('batteryFill').style.width = '100%';
                } else {
                    batSec.classList.add('hidden');
                }
                return;
            }

            tlSec.classList.remove('hidden');
            totBox.classList.remove('hidden');
            noData.classList.add('hidden');
            const isToday = (dayIdx === 1);

            if (isToday) {
                batSec.classList.remove('hidden');
                cursor.style.display = 'block';
                updateCursor();
            } else {
                batSec.classList.add('hidden');
                cursor.style.display = 'none';
            }

            let curH = 0; let totOff = 0;
            const now = new Date();
            const curFloat = now.getHours() + now.getMinutes() / 60 + now.getSeconds() / 3600;
            let foundState = false;
            let lastEndH = 0;

            addLabel(lBox, 0, "00:00", "start");

            scheduleStr.split(',').forEach(part => {
                let type = part.includes('off') ? 'off' : 'on';
                let dur = parseFloat(part.replace('on', '').replace('off', ''));
                if (isNaN(dur) || dur <= 0) return;

                let segStart = curH;
                let endH = curH + dur;

                let seg = document.createElement('div');
                seg.className = `segment ${type}`;
                seg.style.flexGrow = dur;
                seg.style.flexBasis = '0';

                if (dur >= 1.5) {
                    seg.innerHTML = `<div class="segment-icon">${type === 'on' ? 'üí°' : 'üîå'}</div>`;
                }
                track.appendChild(seg);

                seg.addEventListener('click', () => handleSegmentClick(seg, type, segStart, endH, dur));

                if (endH < 23.9 && (endH - lastEndH) > 2.5 && (24 - endH) > 1.5) {
                    addLabel(lBox, endH, formatHM(endH), "mid");
                    lastEndH = endH;
                }

                let card = createCard(segStart, endH, dur, type);
                if (isToday && curFloat >= segStart && curFloat < endH) {
                    card.classList.add('active-now');
                }
                iBox.appendChild(card);

                if (type === 'off') totOff += dur;
                if (isToday && !foundState && curFloat < endH) {
                    foundState = true;
                    startTimer(endH, dur * 3600, type === 'on');
                }
                curH = endH;
            });

            addLabel(lBox, 24, "24:00", "end");

            if (isToday && !foundState) {
                document.getElementById('batteryTimer').innerText = "--:--";
                setBat(0, true);
            }
            totBox.innerHTML = `–í—Å—å–æ–≥–æ –±–µ–∑ —Å–≤—ñ—Ç–ª–∞: <b>${fmtDur(totOff)}</b>`;
        }

        function handleSegmentClick(segEl, type, startH, endH, dur) {
            const detailBox = document.getElementById('detailCardContainer');

            if (activeSegmentElement === segEl) {
                segEl.classList.remove('segment-selected');
                activeSegmentElement = null;
                detailBox.classList.add('hidden');
                detailBox.innerHTML = '';
                return;
            }

            if (activeSegmentElement) {
                activeSegmentElement.classList.remove('segment-selected');
            }
            activeSegmentElement = segEl;
            segEl.classList.add('segment-selected');

            showDetailCard(type === 'on' ? 'on' : 'off', startH, endH, dur);
            try { tg.HapticFeedback.selectionChanged(); } catch (e) { }
        }

        function showDetailCard(type, startH, endH, durH) {
            const box = document.getElementById('detailCardContainer');
            if (!box) return;

            const startStr = formatHM(startH);
            const endStr = formatHM(endH);
            const durStr = fmtDur(durH);

            let titleStatus, icon, headerClass, bodyHtml;

            if (type === 'on') {
                titleStatus = '–°–í–Ü–¢–õ–û –Ñ';
                icon = 'üí°';
                headerClass = 'detail-status-on';
                bodyHtml = `
                    <p>–°–≤—ñ—Ç–ª–æ –±—É–¥–µ –∑ <b>${startStr}</b> –¥–æ <b>${endStr}</b>.</p>
                    <p>–ù–∞—Å—Ç—É–ø–Ω–µ –≤–∏–º–∫–Ω–µ–Ω–Ω—è –æ—á—ñ–∫—É—î—Ç—å—Å—è –æ <b>${endStr}</b>.</p>
                `;
            } else {
                titleStatus = '–í–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø';
                icon = 'üîå';
                headerClass = 'detail-status-off';
                bodyHtml = `
                    <p>–°–≤—ñ—Ç–ª–æ –±—É–¥–µ –≤–∏–º–∫–Ω–µ–Ω–µ –æ <b>${startStr}</b> —ñ –ø–æ–≤–µ—Ä–Ω–µ—Ç—å—Å—è –æ <b>${endStr}</b>.</p>
                    <p>–ü–ª–∞–Ω–æ–≤–µ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è.</p>
                `;
            }

            box.classList.remove('hidden');
            box.innerHTML = `
                <div class="detail-card ${type === 'on' ? 'on' : 'off'}">
                    <div class="detail-header">
                        <div class="detail-left">
                            <div class="detail-icon">${icon}</div>
                            <div class="detail-main">
                                <div class="detail-status ${headerClass}">${titleStatus}</div>
                                <div class="detail-time">${startStr} - ${endStr}</div>
                            </div>
                        </div>
                        <div class="detail-duration">${durStr}</div>
                    </div>
                    <div class="detail-divider"></div>
                    <div class="detail-body">
                        ${bodyHtml}
                        <p class="detail-note">* –í–∫–ª—é—á–µ–Ω–Ω—è/–≤–∏–º–∫–Ω–µ–Ω–Ω—è –º–æ–∂–µ –≤—ñ–¥–±—É–≤–∞—Ç–∏—Å—è –∑ –Ω–µ–≤–µ–ª–∏–∫–æ—é –ø–æ—Ö–∏–±–∫–æ—é —É —á–∞—Å—ñ.</p>
                    </div>
                </div>
            `;
        }

        function addLabel(box, h, txt, align) {
            let el = document.createElement('div');
            el.className = `t-label ${align}`;
            el.innerText = txt;
            el.style.left = (h / 24 * 100) + "%";
            if (align === 'mid') {
                let t = document.createElement('div');
                t.className = 't-tick';
                el.appendChild(t);
            }
            box.appendChild(el);
        }

        function updateCursor() {
            if (currentTab !== 1 || !cursor) return;
            const d = new Date(); const m = d.getHours() * 60 + d.getMinutes();
            let p = m / 1440 * 100; if (p > 100) p = 100;
            cursor.style.left = p + "%";
        }

        function updateTopUpdated() {
            const el = document.getElementById("topUpdated");
            if (!el) return;

            if (window.LAST_UPDATED) {
                el.innerText = formatUpdateTime(window.LAST_UPDATED);
            } else {
                el.innerText = "–û–Ω–æ–≤–ª–µ–Ω–æ‚Ä¶";
            }
        }


        function startTimer(targetH, totalSec, isOn) {
            clearInterval(countdownInterval);
            const n = new Date();
            const tH = Math.floor(targetH); const tM = Math.round((targetH - tH) * 60);
            const tD = new Date(); tD.setHours(tH, tM, 0, 0);
            if (tD < n) tD.setDate(tD.getDate() + 1);
            function tick() {
                const now = new Date();
                const rem = Math.floor((tD - now) / 1000);
                updateCursor();
                if (rem <= 0) {
                    clearInterval(countdownInterval);
                    setTimeout(() => render(currentTab), 1000);
                    return;
                }
                document.getElementById('batteryTimer').innerText = fmtTimer(rem);
                setBat(rem / totalSec, isOn);
            }
            tick(); countdownInterval = setInterval(tick, 1000);
        }

        function setBat(pct, isOn) {
            pct = Math.min(Math.max(pct, 0), 1);
            const f = document.getElementById('batteryFill');
            f.style.width = (pct * 100) + "%";
            f.className = `battery-fill ${isOn ? 'fill-green' : 'fill-red'}`;
            document.getElementById('batteryLabel').innerText = isOn ? '–¥–æ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è' : '–¥–æ –≤–∫–ª—é—á–µ–Ω–Ω—è';
        }

        function createCard(s, e, d, type) {
            let c = document.createElement('div');
            c.className = `card c-${type}`;

            c.innerHTML = `
                <div class="card-header">
                    <div class="card-info">
                        <div class="c-icon">${type==='on'?'üí°':'üîå'}</div>
                        <div class="c-times">
                            <div class="status-label">${type==='on'?'–°–í–Ü–¢–õ–û –Ñ':'–í–Ü–î–ö–õ–Æ–ß–ï–ù–ù–Ø'}</div>
                            <div class="c-time">${formatHM(s)} - ${formatHM(e)}</div>
                        </div>
                    </div>
                    <div class="c-dur">${fmtDur(d)}</div>
                </div>

                <div class="card-details">
                    ${type==='on'
                        ? `
                        –°–≤—ñ—Ç–ª–æ –±—É–¥–µ –∑ <b>${formatHM(s)}</b> –¥–æ <b>${formatHM(e)}</b>.<br>
                        –ù–∞—Å—Ç—É–ø–Ω–µ –≤–∏–º–∫–Ω–µ–Ω–Ω—è –æ—á—ñ–∫—É—î—Ç—å—Å—è –æ <b>${formatHM(e)}</b>.<br><br>
                        <i>* –í–∫–ª—é—á–µ–Ω–Ω—è/–≤–∏–º–∫–Ω–µ–Ω–Ω—è –º–æ–∂–µ –±—É—Ç–∏ –∑ –Ω–µ–≤–µ–ª–∏–∫–æ—é –ø–æ—Ö–∏–±–∫–æ—é.</i>
                        `
                        : `
                        –°–≤—ñ—Ç–ª–æ –±—É–¥–µ –≤–∏–º–∫–Ω–µ–Ω–µ –æ <b>${formatHM(s)}</b> —ñ –ø–æ–≤–µ—Ä–Ω–µ—Ç—å—Å—è –æ <b>${formatHM(e)}</b>.<br>
                        –ü–ª–∞–Ω–æ–≤–µ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è.
                        <br><br>
                        <i>* –í–∫–ª—é—á–µ–Ω–Ω—è/–≤–∏–º–∫–Ω–µ–Ω–Ω—è –º–æ–∂–µ –≤—ñ–¥–±—É–≤–∞—Ç–∏—Å—è –∑ –Ω–µ–≤–µ–ª–∏–∫–æ—é –ø–æ—Ö–∏–±–∫–æ—é —É —á–∞—Å—ñ.</i>
                        `
                    }
                </div>
            `;

            c.addEventListener("click", (ev) => {
                ev.stopPropagation();

                if (activeListCard === c) {
                    c.classList.remove("expanded");
                    activeListCard = null;
                    return;
                }

                if (activeListCard) {
                    activeListCard.classList.remove("expanded");
                }

                c.classList.add("expanded");
                activeListCard = c;
            });

            return c;
        }

        function fmtTimer(s) {
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            const sec = s % 60;
            return `${h}:${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
        }


        function formatHM(dt) {
            let h = Math.floor(dt) % 24;
            let m = Math.round((dt - Math.floor(dt)) * 60);
            if (m === 60) { h = (h + 1) % 24; m = 0; }
            return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
        }

        function fmtDur(dh) {
            let h = Math.floor(dh);
            let m = Math.round((dh - h) * 60);
            return `${h}–≥ ${m > 0 ? m + '—Ö–≤' : ''}`;
        }

        init();
    </script>
</body>
</html>
